<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Mountain - ADMIN DASHBOARD</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        /* --- ASAS --- */
        :root { --bg-dark: #111; --card-bg: #1a1c23; --text: #fff; --border: #333; --sidebar-w: 260px; --brand-red: #ff0000; }
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-w); background: #000; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; height: 100%; position: fixed; left: 0; top: 0; z-index: 1000;
            transition: 0.3s;
        }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-family: 'Russo One'; color: #fff; font-size: 1.4rem; text-decoration: none; }
        .logo span { color: var(--brand-red); }
        
        .nav-menu { flex: 1; overflow-y: auto; padding: 20px 10px; }
        .nav-label { font-size: 0.7rem; color: #666; text-transform: uppercase; font-weight: bold; margin: 15px 10px 5px; letter-spacing: 1px; }
        
        .btn-nav {
            text-decoration: none; color: #aaa; padding: 12px 15px; border-radius: 8px; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 12px; transition: 0.2s; margin-bottom: 5px;
        }
        .btn-nav:hover, .btn-nav.active { background: var(--brand-red); color: #fff; transform: translateX(5px); }
        .btn-nav i { width: 20px; text-align: center; }

        /* --- MAIN CONTENT AREA --- */
        .main-wrapper { flex: 1; margin-left: var(--sidebar-w); display: flex; flex-direction: column; height: 100%; transition: 0.3s; width: 100%; }
        
        /* TOP BAR */
        .topbar {
            background: var(--card-bg); padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .menu-toggle { display: none; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        .admin-badge { display: flex; align-items: center; gap: 10px; background: #000; padding: 8px 15px; border-radius: 30px; border: 1px solid #333; font-size: 0.85rem; color: #ccc; }
        .btn-logout { background: transparent; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; transition: 0.3s; }
        .btn-logout:hover { background: #ff4d4d; color: #fff; }

        /* CONTENT SCROLLABLE */
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; overflow-x: hidden; }

        /* STATS CARDS */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 12px; border-left: 5px solid #ff0000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .stat-card h3 { margin: 0; font-size: 0.8rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 2.2rem; font-weight: bold; margin-top: 10px; }

        /* TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .filter-group { display: flex; gap: 10px; align-items: center; flex: 1; }
        .filter-select { padding: 10px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; flex: 1; max-width: 300px; outline: none; }
        
        .btn-download { background: #28a745; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-download:hover { background: #218838; }
        .btn-analytics { text-decoration: none; background: #3498db; color: #fff; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; display: none; align-items: center; gap: 8px; }

        /* --- TABLE FIX (SCROLLABLE) --- */
        .table-wrapper {
            background: var(--card-bg); border-radius: 10px; padding: 10px; border: 1px solid var(--border);
            width: 100%;
            overflow: hidden; 
        }
        
        .table-container { 
            width: 100%; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 10px;
        }

        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        
        th { text-align: left; padding: 15px; background: #222; color: #aaa; font-size: 0.75rem; border-bottom: 2px solid #333; cursor: pointer; text-transform: uppercase; white-space: nowrap; }
        th:hover { color: #fff; background: #333; }
        
        td { padding: 15px; border-bottom: 1px solid #2a2c35; font-size: 0.9rem; white-space: nowrap; }
        tr:hover { background: #252830; }

        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
        .pending { background: rgba(255, 165, 0, 0.15); color: orange; border: 1px solid orange; }
        .paid { background: rgba(0, 255, 0, 0.15); color: #2ecc71; border: 1px solid #2ecc71; }

        .btn-action { border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-right: 5px; color: white; transition: 0.2s; width: 35px; height: 35px; }
        .btn-delete { background: #ff0000; } .btn-delete:hover { background: #cc0000; }
        .btn-approve { background: #28a745; } .btn-approve:hover { background: #218838; }
        .btn-revoke { background: #e67e22; } .btn-revoke:hover { background: #d35400; }

        /* MOBILE HINT */
        .scroll-hint { display: none; font-size: 0.75rem; color: #888; margin-bottom: 5px; text-align: right; font-style: italic; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 1000px) {
            .sidebar { transform: translateX(-100%); width: 280px; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .main-wrapper { margin-left: 0; width: 100%; }
            .menu-toggle { display: block; }
            .content-scroll { padding: 15px; }
            
            .toolbar { flex-direction: column; align-items: stretch; }
            .filter-select { max-width: 100%; }
            .btn-download, .btn-analytics { justify-content: center; }
            
            .scroll-hint { display: block; }
            .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 900; }
            .overlay.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleMenu()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo">SEA<span>MOUNTAIN</span></a>
            <button class="menu-toggle" onclick="toggleMenu()" style="font-size:1.2rem;"><i class="fas fa-times"></i></button>
        </div>

        <div class="nav-menu">
            <div class="nav-label">Main</div>
            <a href="admin-dashboard.html" class="btn-nav active"><i class="fas fa-home"></i> Dashboard</a>
            <a href="admin-manage-events.html" class="btn-nav"><i class="fas fa-calendar-alt"></i> Manage Events</a>
            <a href="admin-add-event.html" class="btn-nav"><i class="fas fa-plus-circle"></i> Add Event</a>
            
            <div class="nav-label">Tools</div>
            <a href="admin-vouchers.html" class="btn-nav"><i class="fas fa-ticket-alt"></i> Vouchers</a>
            <a href="admin-access.html" class="btn-nav"><i class="fas fa-key"></i> Client Access</a>
            <a href="admin-partners.html" class="btn-nav"><i class="fas fa-handshake"></i> Sponsors & Ads</a>
            
            <div class="nav-label">System</div>
            <a href="admin-scanner.html" class="btn-nav"><i class="fas fa-qrcode"></i> QR Scanner</a>
            <a href="timing-login.html" class="btn-nav"><i class="fas fa-stopwatch"></i> Timing System</a>
            <a href="client-login.html" class="btn-nav"><i class="fas fa-user-tie"></i> Client View</a>
        </div>
    </nav>

    <div class="main-wrapper">
        
        <div class="topbar">
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
                <h2 style="margin:0; font-size:1.2rem;">Overview</h2>
            </div>
            
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="admin-badge" id="adminDisplay">
                    <i class="fas fa-spinner fa-spin"></i> Verifying...
                </div>
                <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div class="content-scroll">
            
            <div class="stats-container">
                <div class="stat-card" style="border-color: #3498db;">
                    <h3>Total Registrations</h3>
                    <div class="value" id="totalReg">0</div>
                </div>
                <div class="stat-card" style="border-color: #2ecc71;">
                    <h3>Paid Participants</h3>
                    <div class="value" id="totalPaid">0</div>
                </div>
                <div class="stat-card" style="border-color: #f1c40f;">
                    <h3>Pending Payment</h3>
                    <div class="value" id="totalPending">0</div>
                </div>
            </div>

            <div class="toolbar">
                <div class="filter-group">
                    <select id="eventFilter" class="filter-select">
                        <option value="all">All Events</option>
                    </select>
                    <a id="btnClientView" href="#" class="btn-analytics">
                        <i class="fas fa-chart-pie"></i> View Analytics
                    </a>
                </div>
                <button onclick="downloadCSV()" class="btn-download"><i class="fas fa-file-csv"></i> Export CSV</button>
            </div>

            <div class="table-wrapper">
                <div class="scroll-hint"><i class="fas fa-arrows-alt-h"></i> Swipe left to see more</div>
                <div class="table-container">
                    <table id="adminTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">EVENT <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(1)">NAME <i class="fas fa-sort"></i></th>
                                <th>CONTACT</th>
                                <th>CATEGORY</th>
                                <th onclick="sortTable(4)">STATUS <i class="fas fa-sort"></i></th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                    <p id="loadingMsg" style="text-align:center; padding:30px; color:#666;">Loading Data...</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
            authDomain: "sea-mountain.firebaseapp.com",
            databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sea-mountain",
            storageBucket: "sea-mountain.firebasestorage.app",
            messagingSenderId: "812228825024",
            appId: "1:812228825024:web:717049c1a64b39c8a60225"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const ALLOWED_ADMIN = "admin@sm.com"; 

        window.toggleMenu = function() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        let allRegistrations = [];

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ALLOWED_ADMIN) {
                document.getElementById('adminDisplay').innerHTML = `<i class="fas fa-user-shield"></i> ${user.email}`;
                loadData();
            } else {
                alert("ACCESS DENIED");
                window.location.href = "admin-login.html"; 
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if(confirm("Log out form dashboard?")) {
                signOut(auth).then(() => { window.location.href = "admin-login.html"; });
            }
        });

        // --- 1. LOAD DATA (CORRECTED KEY LOGIC) ---
        function loadData() {
            const dbRef = ref(db, 'registrations');
            
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                const tableBody = document.getElementById('adminTableBody');
                const eventFilter = document.getElementById('eventFilter');
                
                document.getElementById('loadingMsg').style.display = 'none';
                tableBody.innerHTML = ""; 
                allRegistrations = []; 
                let stats = { total: 0, paid: 0, pending: 0 };
                let eventList = new Set(); 

                if (data) {
                    Object.keys(data).forEach(eventId => {
                        const eventData = data[eventId];
                        if(eventData && typeof eventData === 'object') {
                            eventList.add(eventId); 
                            
                            // PENTING: Iterasi 'regKey' (Kunci Sebenar), bukan 'userId'
                            Object.keys(eventData).forEach(regKey => {
                                const runner = eventData[regKey];
                                
                                // Penapis Ketat + Guna 'regKey' sebagai ID rujukan utama
                                if (runner && 
                                    typeof runner === 'object' && 
                                    runner.first_name && 
                                    regKey !== 'undefined') {
                                    
                                    // SIMPAN 'regKey' sebagai ID utama untuk update/delete
                                    allRegistrations.push({ 
                                        eventId: eventId, 
                                        regKey: regKey, // INI KUNCI SAKTI (-OhB...)
                                        ...runner 
                                    });
                                    
                                    stats.total++;
                                    const statusLower = (runner.status || "").toLowerCase();
                                    if(statusLower === 'paid') stats.paid++; else stats.pending++;
                                }
                            });
                        }
                    });

                    document.getElementById('totalReg').innerText = stats.total;
                    document.getElementById('totalPaid').innerText = stats.paid;
                    document.getElementById('totalPending').innerText = stats.pending;

                    if(eventFilter.options.length === 1) {
                        eventList.forEach(ev => {
                            let option = document.createElement("option");
                            option.value = ev;
                            option.text = ev.toUpperCase();
                            eventFilter.add(option);
                        });
                    }
                    applyFilterAndRender();
                } else {
                    tableBody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No Data Found</td></tr>";
                }
            });
        }

        function applyFilterAndRender() {
            const selectedEvent = document.getElementById('eventFilter').value;
            const btnAnalytics = document.getElementById('btnClientView');

            if(selectedEvent === 'all') {
                renderTable(allRegistrations);
                btnAnalytics.style.display = 'none';
            } else {
                const filtered = allRegistrations.filter(r => r.eventId === selectedEvent);
                renderTable(filtered);
                btnAnalytics.href = `participants.html?id=${selectedEvent}`;
                btnAnalytics.style.display = 'flex';
            }
        }

        window.renderTable = function(dataArray) {
            const tableBody = document.getElementById('adminTableBody');
            tableBody.innerHTML = "";

            if(dataArray.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No matches found</td></tr>";
                return;
            }

            dataArray.forEach(row => {
                const isPaid = (row.status && row.status.toLowerCase() === 'paid');
                const statusClass = isPaid ? "paid" : "pending";
                
                // PENTING: Guna row.regKey untuk fungsi update/delete
                let actionBtn = "";
                if(isPaid) {
                    actionBtn = `<button class="btn-action btn-revoke" title="Revoke Payment" onclick="togglePaymentStatus('${row.eventId}', '${row.regKey}', 'Pending Payment')"><i class="fas fa-undo"></i></button>`;
                } else {
                    actionBtn = `<button class="btn-action btn-approve" title="Mark as Paid" onclick="togglePaymentStatus('${row.eventId}', '${row.regKey}', 'Paid')"><i class="fas fa-check"></i></button>`;
                }

                const htmlRow = `
                    <tr>
                        <td style="color:var(--brand-red); font-weight:bold;">${row.eventId.toUpperCase()}</td>
                        <td>${row.first_name} ${row.last_name || ''}</td>
                        <td>${row.email || '-'}<br><small style="color:#888;">${row.phone || '-'}</small></td>
                        <td>${row.category || '-'} <span style="color:#aaa; font-size:0.8rem;">(${row.tshirt_size || '-'})</span></td>
                        <td><span class="badge ${statusClass}">${row.status || 'Pending Payment'}</span></td>
                        <td style="white-space:nowrap;">
                            ${actionBtn}
                            <button class="btn-action btn-delete" title="Delete User" onclick="deleteRunner('${row.eventId}', '${row.regKey}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += htmlRow;
            });
        }

        document.getElementById('eventFilter').addEventListener('change', applyFilterAndRender);

        window.downloadCSV = function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Event,First Name,Last Name,Email,Phone,Category,Size,Status,Reg Date\n"; 
            allRegistrations.forEach(row => {
                let rowData = [ row.eventId, row.first_name, row.last_name, row.email, row.phone, row.category, row.tshirt_size, row.status, (row.registration_time || "").replace(',', '') ];
                csvContent += rowData.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participants_data.csv");
            document.body.appendChild(link);
            link.click();
        }

        window.sortTable = function(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("adminTable");
            switching = true; dir = "asc"; 
            while (switching) {
                switching = false; rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (dir == "asc") { if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) { shouldSwitch = true; break; } } 
                    else if (dir == "desc") { if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) { shouldSwitch = true; break; } }
                }
                if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount ++; } 
                else { if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; } }
            }
        }

        // --- 2. DELETE FUNCTION (USING REG KEY) ---
        window.deleteRunner = function(eventId, regKey) {
            if(!eventId || !regKey || regKey === 'undefined') {
                alert("Cannot delete: Invalid ID. Try refreshing.");
                return;
            }

            if(confirm("Delete this runner permanently?")) { 
                remove(ref(db, `registrations/${eventId}/${regKey}`))
                .then(() => alert("User Deleted Successfully"))
                .catch((err) => alert("Error deleting: " + err.message)); 
            }
        }
        
        // --- 3. TOGGLE STATUS FUNCTION (USING REG KEY) ---
        window.togglePaymentStatus = function(eventId, regKey, newStatus) {
            if(!eventId || !regKey || regKey === 'undefined') {
                alert("Cannot update: Invalid ID. Try refreshing.");
                return;
            }

            if(confirm(`Confirm change status to '${newStatus}'?`)) { 
                update(ref(db, `registrations/${eventId}/${regKey}`), { status: newStatus })
                .then(() => {
                    alert("Success! Status updated to " + newStatus);
                })
                .catch((err) => {
                    alert("Error updating status: " + err.message);
                });
            }
        }

    </script>
</body>
</html>
