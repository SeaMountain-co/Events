<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Mountain - ADMIN DASHBOARD</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        /* --- ASAS --- */
        :root { --bg-dark: #111; --card-bg: #1a1c23; --text: #fff; --border: #333; }
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; }
        * { box-sizing: border-box; }

        /* --- HEADER / NAVBAR --- */
        .navbar {
            background-color: #000;
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo { font-family: 'Russo One'; color: #ff0000; font-size: 1.4rem; text-decoration: none; }
        .admin-badge { color: #888; font-size: 0.8rem; background: #222; padding: 5px 10px; border-radius: 4px; }

        /* MENU BUTTONS */
        .nav-menu { display: flex; gap: 10px; align-items: center; }
        
        .btn-nav {
            text-decoration: none;
            color: #fff; /* SEMUA TULISAN PUTIH */
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            border: 1px solid transparent;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* Tambah shadow sikit supaya nampak jelas */
        }
        .btn-nav:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* WARNA BUTANG (Fixed Text Color) */
        .nav-manage { background: #e67e22; }
        .nav-add { background: #35a1ff; }
        .nav-voucher { background: #c0540c; }
        
        /* WARNA HIJAU & BIRU (Tulisan Putih) */
        .nav-access { background: #3498db; color: #fff; }
        .nav-scanner { background: #2ecc71; color: #fff; } 
        .nav-timing { background: #00d2ff; color: #fff; } 
        .nav-client { background: #9b59b6; color: #fff; }
        .nav-logout { background: #333; border: 1px solid #555; }
        .nav-logout:hover { background: #ff0000; border-color: #ff0000; }

        .menu-toggle { display: none; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }

        /* --- CONTENT --- */
        .main-content { padding: 20px; max-width: 1400px; margin: 0 auto; }

        /* STATS */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 12px; border-left: 5px solid #ff0000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .stat-card h3 { margin: 0; font-size: 0.8rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 2.2rem; font-weight: bold; margin-top: 10px; }

        /* TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .filter-group { display: flex; gap: 10px; align-items: center; flex: 1; }
        .filter-select { padding: 10px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; flex: 1; max-width: 300px; }
        
        .btn-download { background: #28a745; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-download:hover { background: #218838; }

        /* TABLE */
        .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 10px; padding: 5px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { text-align: left; padding: 15px; background: #222; color: #aaa; font-size: 0.75rem; border-bottom: 2px solid #333; cursor: pointer; text-transform: uppercase; }
        th:hover { color: #fff; background: #333; }
        td { padding: 15px; border-bottom: 1px solid #2a2c35; font-size: 0.9rem; }
        tr:hover { background: #252830; }

        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
        .pending { background: rgba(255, 165, 0, 0.15); color: orange; border: 1px solid orange; }
        .paid { background: rgba(0, 255, 0, 0.15); color: #2ecc71; border: 1px solid #2ecc71; }

        .btn-action { border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-right: 5px; color: white; transition: 0.2s; width: 35px; height: 35px; }
        .btn-delete { background: #ff0000; } .btn-delete:hover { background: #cc0000; }
        .btn-approve { background: #28a745; } .btn-approve:hover { background: #218838; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) {
            .navbar { flex-wrap: wrap; padding: 15px; }
            .menu-toggle { display: block; }
            .nav-menu { display: none; flex-direction: column; width: 100%; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
            .nav-menu.active { display: flex; }
            .btn-nav { width: 100%; justify-content: center; padding: 12px; font-size: 1rem; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .filter-select { max-width: 100%; }
            .btn-download { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-section">
            <div class="logo">ADMIN PANEL</div>
            <span id="adminDisplay" class="admin-badge"><i class="fas fa-spinner fa-spin"></i> Verifying...</span>
        </div>

        <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

        <div class="nav-menu" id="navMenu">
            <a href="admin-manage-events.html" class="btn-nav nav-manage"><i class="fas fa-calendar-alt"></i> Manage Events</a>
            <a href="admin-add-event.html" class="btn-nav nav-add"><i class="fa-solid fa-plus"></i> Add Event</a>
            <a href="admin-vouchers.html" class="btn-nav nav-voucher"><i class="fa-solid fa-ticket"></i> Voucher</a>
            <a href="admin-access.html" class="btn-nav nav-access"><i class="fa-solid fa-key"></i> Client Access</a>
            <a href="admin-scanner.html" class="btn-nav nav-scanner"><i class="fa-solid fa-camera"></i> QR Scanner</a>
            <a href="timing-login.html" class="btn-nav nav-timing"><i class="fa-solid fa-stopwatch"></i> Timing System</a>
            <a href="client-login.html" class="btn-nav nav-client"><i class="fa-solid fa-user-tie"></i> Client Landing</a>

            <button id="logoutBtn" class="btn-nav nav-logout"><i class="fas fa-sign-out-alt"></i> Log Out</button>
        </div>
    </nav>

    <div class="main-content">

        <div class="stats-container">
            <div class="stat-card" style="border-color: #3498db;">
                <h3>Total Registrations</h3>
                <div class="value" id="totalReg">0</div>
            </div>
            <div class="stat-card" style="border-color: #2ecc71;">
                <h3>Paid Participants</h3>
                <div class="value" id="totalPaid">0</div>
            </div>
            <div class="stat-card" style="border-color: #f1c40f;">
                <h3>Pending Payment</h3>
                <div class="value" id="totalPending">0</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="filter-group">
                <select id="eventFilter" class="filter-select">
                    <option value="all">All Events</option>
                </select>
                <a id="btnClientView" href="#" class="btn-nav" style="background:#555; display:none;">
                    <i class="fas fa-chart-pie"></i> Analytics
                </a>
            </div>
            <button onclick="downloadCSV()" class="btn-download"><i class="fas fa-file-csv"></i> Export CSV</button>
        </div>

        <div class="table-container">
            <table id="adminTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">EVENT <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(1)">NAME <i class="fas fa-sort"></i></th>
                        <th>CONTACT</th>
                        <th>CATEGORY</th>
                        <th onclick="sortTable(4)">STATUS <i class="fas fa-sort"></i></th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
            <p id="loadingMsg" style="text-align:center; padding:30px; color:#666;">Loading Data...</p>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
            authDomain: "sea-mountain.firebaseapp.com",
            databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sea-mountain",
            storageBucket: "sea-mountain.firebasestorage.app",
            messagingSenderId: "812228825024",
            appId: "1:812228825024:web:717049c1a64b39c8a60225"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const ALLOWED_ADMIN = "admin@sm.com"; 

        window.toggleMenu = function() {
            document.getElementById('navMenu').classList.toggle('active');
        }

        let allRegistrations = [];

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ALLOWED_ADMIN) {
                document.getElementById('adminDisplay').innerHTML = `<i class="fas fa-user-shield"></i> Hello, Admin`;
                loadData();
            } else {
                alert("ACCESS DENIED");
                window.location.href = "admin-login.html"; 
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => { window.location.href = "admin-login.html"; });
        });

        function loadData() {
            const dbRef = ref(db, 'registrations');
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                const tableBody = document.getElementById('adminTableBody');
                const eventFilter = document.getElementById('eventFilter');
                
                document.getElementById('loadingMsg').style.display = 'none';
                tableBody.innerHTML = ""; 
                allRegistrations = []; 
                let stats = { total: 0, paid: 0, pending: 0 };
                let eventList = new Set(); 

                if (data) {
                    Object.keys(data).forEach(eventId => {
                        eventList.add(eventId); 
                        const eventData = data[eventId];
                        Object.keys(eventData).forEach(userId => {
                            const runner = eventData[userId];
                            allRegistrations.push({ eventId: eventId, userId: userId, ...runner });
                            stats.total++;
                            if(runner.status === 'Paid') stats.paid++; else stats.pending++;
                        });
                    });

                    document.getElementById('totalReg').innerText = stats.total;
                    document.getElementById('totalPaid').innerText = stats.paid;
                    document.getElementById('totalPending').innerText = stats.pending;

                    if(eventFilter.options.length === 1) {
                        eventList.forEach(ev => {
                            let option = document.createElement("option");
                            option.value = ev;
                            option.text = ev.toUpperCase();
                            eventFilter.add(option);
                        });
                    }
                    renderTable(allRegistrations);
                } else {
                    tableBody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No Data Found</td></tr>";
                }
            });
        }

        // --- RENDER TABLE (FIXED LOGIC) ---
        window.renderTable = function(dataArray) {
            const tableBody = document.getElementById('adminTableBody');
            tableBody.innerHTML = "";

            dataArray.forEach(row => {
                // FIX: Check huruf kecil 'paid' supaya "PAID" atau "Paid" tetap jadi hijau
                const statusClass = (row.status && row.status.toLowerCase() === 'paid') ? "paid" : "pending";
                
                const htmlRow = `
                    <tr>
                        <td style="color:#ff0000; font-weight:bold;">${row.eventId.toUpperCase()}</td>
                        <td>${row.first_name} ${row.last_name}</td>
                        <td>${row.email}<br><small style="color:#888;">${row.phone}</small></td>
                        <td>${row.category} (${row.tshirt_size})</td>
                        <td><span class="badge ${statusClass}">${row.status}</span></td>
                        <td>
                            <button class="btn-action btn-approve" title="Approve Payment" onclick="updateStatus('${row.eventId}', '${row.userId}')"><i class="fas fa-check"></i></button>
                            <button class="btn-action btn-delete" title="Delete User" onclick="deleteRunner('${row.eventId}', '${row.userId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += htmlRow;
            });
        }

        document.getElementById('eventFilter').addEventListener('change', function() {
            const selectedEvent = this.value;
            const btnAnalytics = document.getElementById('btnClientView');
            if(selectedEvent === 'all') {
                renderTable(allRegistrations);
                btnAnalytics.style.display = 'none'; 
            } else {
                const filtered = allRegistrations.filter(r => r.eventId === selectedEvent);
                renderTable(filtered);
                btnAnalytics.href = `participants.html?id=${selectedEvent}`;
                btnAnalytics.style.display = 'inline-flex';
            }
        });

        window.downloadCSV = function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Event,First Name,Last Name,Email,Phone,Category,Size,Status,Reg Date\n"; 
            allRegistrations.forEach(row => {
                let rowData = [ row.eventId, row.first_name, row.last_name, row.email, row.phone, row.category, row.tshirt_size, row.status, (row.registration_time || "").replace(',', '') ];
                csvContent += rowData.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participants_data.csv");
            document.body.appendChild(link);
            link.click();
        }

        window.sortTable = function(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("adminTable");
            switching = true; dir = "asc"; 
            while (switching) {
                switching = false; rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (dir == "asc") { if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) { shouldSwitch = true; break; } } 
                    else if (dir == "desc") { if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) { shouldSwitch = true; break; } }
                }
                if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount ++; } 
                else { if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; } }
            }
        }

        window.deleteRunner = function(eventId, userId) {
            if(confirm("Delete this runner permanently?")) { remove(ref(db, `registrations/${eventId}/${userId}`)).then(() => alert("User Deleted")); }
        }
        window.updateStatus = function(eventId, userId) {
            if(confirm("Confirm payment received?")) { update(ref(db, `registrations/${eventId}/${userId}`), { status: "Paid" }).then(() => alert("Status Updated!")); }
        }
    </script>
</body>
</html>
