<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - Sea Mountain</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-red: #ff0000; --bg-dark: #0f1014; --card-bg: #1a1c23; --text: #ffffff; }
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding-bottom: 50px; }
        
        /* HEADER */
        .header { padding: 20px 5%; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-family: 'Russo One'; font-size: 1.2rem; color: #fff; text-decoration: none; }
        .logo span { color: var(--brand-red); }

        .container { max-width: 1200px; margin: 40px auto; display: flex; gap: 50px; padding: 0 5%; }
        
        /* LEFT COLUMN: FORM */
        .form-section { flex: 1.6; }
        h2 { font-family: 'Russo One'; text-transform: uppercase; margin-bottom: 25px; font-size: 1.5rem; border-bottom: 2px solid var(--brand-red); display: inline-block; padding-bottom: 5px; }
        
        .form-card { background: var(--card-bg); padding: 35px; border-radius: 15px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 25px; } /* Jarak bawah setiap input */
        
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #aaa; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .form-control { width: 100%; padding: 14px; background: #0a0b0e; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 1rem; outline: none; transition: 0.3s; font-family: 'Montserrat'; }
        .form-control:focus { border-color: var(--brand-red); box-shadow: 0 0 15px rgba(255,0,0,0.2); background: #111; }
        
        /* JARAK ANTARA KIRI & KANAN DALAM SATU ROW */
        .form-row { display: flex; gap: 30px; } 
        .form-row .form-group { flex: 1; }

        .section-label { color: var(--brand-red); font-weight: 800; margin-top: 40px; margin-bottom: 20px; text-transform: uppercase; border-top: 1px solid #333; padding-top: 25px; font-size: 1.1rem; letter-spacing: 1px; }

        /* CHECKBOX */
        .terms-group { display: flex; align-items: flex-start; gap: 10px; margin-top: 20px; font-size: 0.9rem; color: #888; }
        .terms-group input { margin-top: 4px; accent-color: var(--brand-red); width: 18px; height: 18px; }
        .terms-group a { color: var(--brand-red); text-decoration: none; font-weight: bold; }

        /* RIGHT COLUMN: SUMMARY (STICKY) */
        .summary-section { flex: 1; position: sticky; top: 100px; height: fit-content; }
        .summary-card { background: #fff; color: #000; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .summary-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: repeating-linear-gradient(45deg, #ff0000, #ff0000 10px, #000 10px, #000 20px); }

        .event-mini-info { display: flex; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .mini-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .mini-details h4 { margin: 0 0 5px 0; font-family: 'Russo One'; font-size: 1.1rem; text-transform: uppercase; line-height: 1.2; }
        .mini-details p { margin: 0; color: #666; font-size: 0.85rem; font-weight: 600; }

        /* VOUCHER */
        .voucher-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .voucher-input { flex: 1; padding: 12px; border: 2px dashed #ccc; border-radius: 6px; text-transform: uppercase; font-weight: bold; text-align: center; font-size: 1rem; letter-spacing: 2px; }
        
        .btn-apply { background: #000; color: #fff; border: none; padding: 0 25px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-apply:hover { background: #333; }
        
        /* Tombol Cancel (Merah) */
        .btn-remove { background: #d9534f; color: #fff; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; display: none; transition: 0.3s; }
        .btn-remove:hover { background: #c9302c; }

        /* PRICE */
        .price-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; color: #555; font-weight: 500; }
        .price-row.total { font-size: 1.6rem; font-weight: 900; color: #000; margin-top: 25px; border-top: 2px solid #000; padding-top: 15px; align-items: center; }
        .discount-text { color: #28a745; font-weight: bold; }

        .btn-pay { background: var(--brand-red); color: #fff; width: 100%; padding: 18px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(255,0,0,0.4); }
        .btn-pay:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255,0,0,0.6); }

        @media (max-width: 900px) { .container { flex-direction: column; } .summary-section { order: -1; position: relative; top: 0; } .form-row { flex-direction: column; gap: 0; } }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="logo">SEA<span>MOUNTAIN</span></a>
        <a href="index.html" style="color:#aaa; text-decoration:none; font-weight:bold; font-size: 0.9rem;"><i class="fas fa-times"></i> CANCEL REGISTRATION</a>
    </div>

    <div class="container">
        
        <div class="form-section">
            <h2>Participant Details</h2>
            <div class="form-card">
                <form id="regForm">
                    
                    <div class="section-label" style="margin-top:0;">Personal Information</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="firstName" class="form-control" placeholder="Enter First Name" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName" class="form-control" placeholder="Enter Last Name" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>IC / Passport No.</label>
                            <input type="text" id="ic" class="form-control" placeholder="e.g. 901010-10-1234" required>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dob" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="gender" class="form-control" required>
                                <option value="" disabled selected>Select Gender</option>
                                <option>Male</option><option>Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phone" class="form-control" placeholder="+60..." required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>

                    <div class="section-label">Mailing Address</div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="address" class="form-control" placeholder="Street address, Unit..." required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="city" class="form-control" placeholder="Enter City" required>
                        </div>
                        <div class="form-group">
                            <label>Postcode</label>
                            <input type="text" id="postcode" class="form-control" placeholder="Poscode" required>
                        </div>
                    </div>

                    <div class="section-label">Race Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Race Category</label>
                            <select id="category" class="form-control" required>
                                <option value="" disabled selected>Select Category</option>
                                <option value="5km">5KM Fun Run</option>
                                <option value="10km">10KM Speed</option>
                                <option value="21km">21KM Half Marathon</option>
                                <option value="50km">50KM Ultra Trail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>T-Shirt Size</label>
                            <select id="tshirt" class="form-control" required>
                                <option value="" disabled selected>Select Size</option>
                                <option value="xs">XS</option><option value="s">S</option><option value="m">M</option><option value="l">L</option><option value="xl">XL</option><option value="xxl">XXL</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-label">Emergency Contact</div>
                    <div class="form-group">
                        <label>Name Emergency Contact</label>
                        <input type="text" id="emergencyName" class="form-control" placeholder="Name of next of kin" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number Emergency Contact</label>
                        <input type="tel" id="emergencyPhone" class="form-control" placeholder="+60..." required>
                    </div>

                    <div class="terms-group">
                        <input type="checkbox" id="terms" required>
                        <label for="terms">I agree to the <a href="#">terms and conditions</a> and acknowledge the <a href="#">privacy policy</a>.</label>
                    </div>

                </form>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-card">
                <h3 style="margin-top:0; font-family:'Russo One'; margin-bottom: 25px;">ORDER SUMMARY</h3>
                
                <div class="event-mini-info">
                    <img id="eventImg" src="" class="mini-img">
                    <div class="mini-details">
                        <h4 id="eventTitle">Loading Event...</h4>
                        <p id="eventDate"><i class="far fa-calendar-alt"></i> -</p>
                    </div>
                </div>

                <label style="font-size:0.8rem; font-weight:bold; color:#555; display:block; margin-bottom:8px;">HAVE A PROMO CODE?</label>
                <div class="voucher-box">
                    <input type="text" id="voucherCode" class="voucher-input" placeholder="CODE">
                    
                    <button type="button" id="btnApply" class="btn-apply">APPLY</button>
                    
                    <button type="button" id="btnRemove" class="btn-remove" title="Remove Voucher"><i class="fas fa-times"></i></button>
                </div>
                
                <div id="voucherMsg" style="font-size:0.8rem; margin-top:-15px; margin-bottom:15px; display:none; font-weight: 600;"></div>

                <div class="price-row">
                    <span>Registration Fee</span>
                    <span id="displayPrice">RM 0.00</span>
                </div>
                <div class="price-row" id="rowDiscount" style="display:none;">
                    <span class="discount-text">Discount (<span id="appliedCode"></span>)</span>
                    <span class="discount-text">- RM <span id="discountVal">0.00</span></span>
                </div>
                <div class="price-row">
                    <span>Processing Fee</span>
                    <span>RM 0.00</span>
                </div>

                <div class="price-row total">
                    <span>TOTAL</span>
                    <span style="color:var(--brand-red)" id="finalTotal">RM 0.00</span>
                </div>

                <button type="button" id="payBtn" class="btn-pay">COMPLETE REGISTRATION</button>
                <p style="text-align:center; font-size:0.75rem; color:#888; margin-top:15px;">
                    <i class="fas fa-lock"></i> Secure Payment by SeaMountain Pay
                </p>
            </div>
        </div>

    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, push, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG FIREBASE ANDA ---
    const firebaseConfig = {
        apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
        authDomain: "sea-mountain.firebaseapp.com",
        databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sea-mountain",
        storageBucket: "sea-mountain.firebasestorage.app",
        messagingSenderId: "812228825024",
        appId: "1:812228825024:web:717049c1a64b39c8a60225"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Global Variables
    let originalPrice = 0;
    let finalAmount = 0;
    let discountAmount = 0;
    let currentUser = null;
    let currentVoucherCode = null; // Simpan kod voucher yang sedang diguna
    
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || urlParams.get('id');

    // 1. CHECK AUTH
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('email').value = user.email;
        } else {
            alert("Please Log In first.");
            window.location.href = "login.html";
        }
    });

    // 2. LOAD EVENT DATA & PRICE
    if(eventId) {
        get(ref(db, 'events/' + eventId)).then((snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                
                document.getElementById('eventTitle').innerText = data.title;
                document.getElementById('eventDate').innerHTML = `<i class="far fa-calendar-alt"></i> ${data.date}`;
                if(data.image_url) document.getElementById('eventImg').src = data.image_url;
                
                let priceString = String(data.price).replace(/[^0-9.]/g, ''); 
                originalPrice = parseFloat(priceString) || 0;
                finalAmount = originalPrice;

                updatePriceUI();
            } else {
                alert("Event not found.");
                window.location.href = "index.html";
            }
        });
    } else {
        alert("No event selected.");
        window.location.href = "index.html";
    }

    // 3. VOUCHER LOGIC (ADVANCED: LIMIT & EXPIRY & PERCENT)
    document.getElementById('btnApply').addEventListener('click', () => {
        const codeInput = document.getElementById('voucherCode');
        const code = codeInput.value.trim().toUpperCase();
        const msg = document.getElementById('voucherMsg');

        if(!code) return;

        get(ref(db, 'vouchers/' + code)).then((snapshot) => {
            if(snapshot.exists()) {
                const voucher = snapshot.val();
                const now = new Date();
                const expiryDate = new Date(voucher.expiry);
                
                // A. Check Expiry
                // Set expiry date to end of day
                expiryDate.setHours(23, 59, 59);
                if (now > expiryDate) {
                    showError(msg, "Voucher has expired.");
                    return;
                }

                // B. Check Limit
                if (voucher.used >= voucher.limit) {
                    showError(msg, "Voucher fully redeemed (Limit Reached).");
                    return;
                }

                // C. Calculate Discount (Fixed vs Percent)
                if (voucher.type === 'percent') {
                    // Contoh: 10% dari RM 50 = RM 5
                    discountAmount = originalPrice * (parseFloat(voucher.value) / 100);
                } else {
                    // Contoh: RM 10 off
                    discountAmount = parseFloat(voucher.value);
                }

                // Pastikan diskaun tak lebih dari harga asal (Tak boleh negatif)
                if(discountAmount > originalPrice) discountAmount = originalPrice;
                finalAmount = originalPrice - discountAmount;

                // Update UI Success
                document.getElementById('rowDiscount').style.display = 'flex';
                document.getElementById('discountVal').innerText = discountAmount.toFixed(2);
                document.getElementById('appliedCode').innerText = code;
                
                msg.style.display = 'block';
                msg.style.color = '#28a745';
                msg.innerText = "Voucher Applied Successfully!";
                
                codeInput.disabled = true;
                document.getElementById('btnApply').style.display = 'none';
                document.getElementById('btnRemove').style.display = 'inline-block';

                currentVoucherCode = code; // Simpan kod untuk update count nanti
                updatePriceUI();

            } else {
                showError(msg, "Invalid Voucher Code.");
            }
        });
    });

    function showError(element, text) {
        element.style.display = 'block';
        element.style.color = '#d9534f';
        element.innerText = text;
        
        // Reset Price
        discountAmount = 0;
        finalAmount = originalPrice;
        currentVoucherCode = null;
        document.getElementById('rowDiscount').style.display = 'none';
        updatePriceUI();
    }

    // 4. REMOVE VOUCHER
    document.getElementById('btnRemove').addEventListener('click', () => {
        const codeInput = document.getElementById('voucherCode');
        const msg = document.getElementById('voucherMsg');

        discountAmount = 0;
        finalAmount = originalPrice;
        currentVoucherCode = null;
        
        codeInput.value = "";
        codeInput.disabled = false;
        msg.style.display = 'none';
        document.getElementById('rowDiscount').style.display = 'none';
        
        document.getElementById('btnApply').style.display = 'inline-block';
        document.getElementById('btnRemove').style.display = 'none';

        updatePriceUI();
    });

    function updatePriceUI() {
        document.getElementById('displayPrice').innerText = "RM " + originalPrice.toFixed(2);
        document.getElementById('finalTotal').innerText = "RM " + finalAmount.toFixed(2);
    }

    // 5. SUBMIT FORM & UPDATE VOUCHER USAGE
    document.getElementById('payBtn').addEventListener('click', () => {
        const form = document.getElementById('regForm');
        if(!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        if(confirm(`Confirm registration and payment of RM ${finalAmount.toFixed(2)}?`)) {
            
            // Generate Registration ID
            const regRef = push(ref(db, 'registrations/' + eventId));
            
            const regData = {
                userId: currentUser.uid,
                event_code: eventId,
                event_name: document.getElementById('eventTitle').innerText,
                
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                ic: document.getElementById('ic').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                postcode: document.getElementById('postcode').value,
                
                category: document.getElementById('category').value,
                tshirt_size: document.getElementById('tshirt').value,
                
                emergencyName: document.getElementById('emergencyName').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                
                amountPaid: finalAmount,
                voucherUsed: currentVoucherCode || "NONE",
                status: 'paid',
                registration_time: new Date().toLocaleString()
            };

            set(regRef, regData).then(() => {
                
                // A. Update Registered Count di Event
                const eventCountRef = ref(db, 'events/' + eventId + '/registered');
                runTransaction(eventCountRef, (currentCount) => {
                    return (currentCount || 0) + 1;
                });

                // B. Update Voucher Usage (KALAU ADA VOUCHER)
                if (currentVoucherCode) {
                    const voucherUsedRef = ref(db, 'vouchers/' + currentVoucherCode + '/used');
                    runTransaction(voucherUsedRef, (currentUsed) => {
                        return (currentUsed || 0) + 1;
                    });
                }

                alert("Registration Successful! See you at the race.");
                window.location.href = "index.html";
            })
            .catch((error) => {
                alert("Error: " + error.message);
            });
        }
    });

</script>

</body>
</html>
