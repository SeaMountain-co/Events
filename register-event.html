<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Acara - Sea Mountain</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-red: #ff0000; --brand-yellow: #ffcc00; --bg-dark: #0f1014; --card-bg: #1a1c23; --text-primary: #ffffff; --text-secondary: #aaaaaa; --input-bg: #0a0b0e; --border-color: #333; }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Montserrat', sans-serif; margin: 0; padding-bottom: 80px; }

        .header { padding: 15px 5%; background: rgba(15, 16, 20, 0.95); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 999; backdrop-filter: blur(10px); }
        .logo { font-family: 'Russo One', sans-serif; font-size: 1.2rem; color: #fff; text-decoration: none; text-transform: uppercase; }
        .logo span { color: var(--brand-red); }
        .exit-link { color: var(--text-secondary); text-decoration: none; font-weight: 700; font-size: 0.8rem; transition: color 0.3s; }
        .exit-link:hover { color: #fff; }

        /* STEPPER CSS */
        .stepper-container { max-width: 900px; margin: 30px auto; padding: 0 20px; overflow-x: auto; scrollbar-width: none; }
        .stepper-wrapper { display: flex; justify-content: space-between; align-items: flex-start; position: relative; min-width: 500px; }
        .step-item { position: relative; z-index: 1; text-align: center; flex: 1; }
        .step-item::after { content: ''; position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background-color: #333; z-index: -1; transform: translateY(-50%); }
        .step-item:last-child::after { display: none; }
        .step-item.completed::after { background-color: var(--brand-red); transition: background-color 0.4s ease; }
        .step-circle { width: 32px; height: 32px; background: #222; border: 2px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 0.85rem; font-weight: bold; color: #666; position: relative; z-index: 2; transition: all 0.3s ease; }
        .step-item.active .step-circle { background: var(--brand-yellow); border-color: var(--brand-yellow); color: #000; box-shadow: 0 0 15px rgba(255, 204, 0, 0.4); transform: scale(1.2); }
        .step-item.completed .step-circle { background: var(--brand-red); border-color: var(--brand-red); color: #fff; }
        
        .container { max-width: 1300px; margin: 0 auto; display: flex; gap: 40px; padding: 0 5%; align-items: flex-start; }
        .form-section { flex: 2; width: 100%; }
        .summary-section { flex: 1; width: 100%; position: sticky; top: 90px; height: fit-content; }

        .form-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .form-card-body { padding: 40px; }
        .summary-card { padding: 30px; background: #fff; color: #000; border-top: 5px solid var(--brand-red); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 12px; }

        .step-content { display: none; animation: fadeIn 0.4s forwards; }
        .step-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .step-header { border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        .step-title { font-family: 'Russo One', sans-serif; font-size: 1.5rem; color: var(--brand-yellow); text-transform: uppercase; margin: 0; }
        .step-desc { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 700; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; height: 50px; padding: 0 20px; background: var(--input-bg); border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 0.95rem; font-family: 'Montserrat', sans-serif; outline: none; transition: border-color 0.3s; }
        .form-control:focus { border-color: var(--brand-yellow); }
        
        .checkbox-group { display: flex; flex-direction: column; gap: 15px; background: #15161b; padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 12px; font-size: 0.95rem; color: #ddd; cursor: pointer; line-height: 1.4; }
        .checkbox-item input { margin-top: 4px; accent-color: var(--brand-yellow); width: 18px; height: 18px; flex-shrink: 0; }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; }
        .btn-nav { padding: 15px 35px; border-radius: 8px; font-weight: 800; text-transform: uppercase; cursor: pointer; border: none; transition: all 0.3s; font-size: 0.9rem; }
        .btn-prev { background: #333; color: #fff; } .btn-prev:hover { background: #444; }
        .btn-next { background: var(--brand-yellow); color: #000; } .btn-next:hover { background: #e6b800; transform: translateY(-2px); }

        .btn-pay { width: 100%; padding: 18px; background: var(--brand-red); color: #fff; font-weight: 900; text-transform: uppercase; border: none; border-radius: 50px; cursor: pointer; margin-top: 25px; transition: all 0.3s; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(255,0,0,0.3); }
        .btn-pay:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(255,0,0,0.5); }
        .btn-pay:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }

        .racer-box { border: 1px solid #333; padding: 25px; margin-bottom: 25px; border-radius: 10px; background: #121318; }
        .racer-title { color: var(--brand-yellow); font-weight: 800; margin-bottom: 20px; font-size: 1rem; text-transform: uppercase; border-bottom: 1px dashed #444; padding-bottom: 10px; }

        .event-mini { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .mini-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; }
        .mini-info h4 { margin: 0; font-family: 'Russo One'; font-size: 1.1rem; line-height: 1.3; text-transform: uppercase; }
        .mini-info p { margin: 5px 0 0; font-size: 0.85rem; color: #666; font-weight: 600; }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; font-weight: 600; color: #555; }
        .price-total { font-size: 1.5rem; font-weight: 900; color: #000; margin-top: 25px; border-top: 2px solid #000; padding-top: 15px; display: flex; justify-content: space-between; }
        .voucher-input-group { display: flex; gap: 8px; margin-top: 5px; }
        .voucher-input-group input { flex: 1; padding: 12px; border: 2px dashed #ccc; border-radius: 6px; text-transform: uppercase; font-weight: 800; text-align: center; }
        .btn-apply { background: #000; color: #fff; border: none; padding: 0 25px; border-radius: 6px; cursor: pointer; font-weight: 800; }
        .active-voucher-badge { display: none; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 12px 15px; border-radius: 8px; margin-top: 15px; box-shadow: 0 5px 15px rgba(56, 239, 125, 0.3); }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        @media (max-width: 900px) {
            .container { flex-direction: column; padding: 0 20px; }
            .form-section { order: 1; }
            .summary-section { order: 2; position: relative; top: 0; margin-top: 20px; }
            .form-card-body { padding: 25px; }
            .stepper-container { max-width: 100%; margin: 20px 0; }
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="logo">SEA<span>MOUNTAIN</span></a>
        <a href="index.html" class="exit-link"><i class="fas fa-times"></i> EXIT REGISTRATION</a>
    </div>

    <div class="stepper-container">
        <div class="stepper-wrapper" id="stepperWrapper">
            </div>
    </div>

    <div class="container">
        <div class="form-section">
            <form id="regForm">
                <div class="step-content active" id="step1">
                    <div class="form-card">
                        <div class="form-card-body">
                            <div class="step-header">
                                <h3 class="step-title">1. Team Information</h3>
                                <p class="step-desc">One submission per team.</p>
                            </div>
                            <div class="form-group"><label>Team Name</label><input type="text" id="teamName" class="form-control" required placeholder="Enter your team name"></div>
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                 <div><label>Captain Name</label><input type="text" id="captainName" class="form-control" required></div>
                                 <div><label>Captain Mobile</label><input type="tel" id="captainMobile" class="form-control" required placeholder="+60..."></div>
                            </div>
                            <div class="form-group"><label>Captain Email</label><input type="email" id="captainEmail" class="form-control" required></div>
                            <div class="form-group"><label>Country of Team</label>
                                <select id="teamCountry" class="form-control" required><option value="" disabled selected>Select Country</option><option value="Malaysia">Malaysia</option><option value="Other">Other</option></select>
                            </div>
                            <div class="form-group"><label>Race Category</label>
                                <select id="raceCategory" class="form-control" required onchange="updateRacersCount()"><option value="" disabled selected>Loading Categories...</option></select>
                            </div>
                            <div class="form-group"><label>Emergency Contact (Non-racer)</label><input type="text" id="emergencyName" class="form-control" required placeholder="Name of next of kin"></div>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="step2">
                    <div class="form-card">
                        <div class="form-card-body">
                            <div class="step-header">
                                <h3 class="step-title">2. Racer Details</h3>
                                <p class="step-desc">Please fill in details for all team members carefully.</p>
                            </div>
                            <div id="racersContainer"></div>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="step3">
                    <div class="form-card">
                        <div class="form-card-body">
                            <div class="step-header"><h3 class="step-title">3. Medical & Safety</h3><p class="step-desc">Confidential Info.</p></div>
                            <div class="form-group"><label>Blood Group(s)</label><input type="text" id="medBlood" class="form-control" placeholder="e.g. Captain: O+, Member 2: A..." required></div>
                            <div class="form-group"><label>Known Medical Conditions</label><input type="text" id="medCondition" class="form-control" placeholder="Put 'None' if applicable" required></div>
                            <div class="form-group"><label>Current Medication</label><input type="text" id="medMeds" class="form-control" placeholder="If any" required></div>
                            <div class="form-group"><label>Allergies</label><input type="text" id="medAllergy" class="form-control" placeholder="Put 'None' if applicable" required></div>
                            <div class="form-group"><label>Special Medical Notes</label><textarea id="medNotes" class="form-control" rows="3"></textarea></div>
                            <div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" required> I declare the above information is true.</label></div>
                        </div>
                    </div>
                </div>

                <div id="dynamicStepsContainer"></div>

                <div class="step-content" id="step-media">
                    <div class="form-card">
                        <div class="form-card-body">
                            <div class="step-header"><h3 class="step-title" id="mediaTitle">Media & Communication</h3></div>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" required> I consent to photography and video recording.</label>
                                <label class="checkbox-item"><input type="checkbox" required> I agree to receive official updates.</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="step-final">
                    <div class="form-card">
                        <div class="form-card-body">
                            <div class="step-header"><h3 class="step-title" id="finalTitle">Final Acknowledgement</h3></div>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" required> I confirm all information provided is accurate.</label>
                                <label class="checkbox-item"><input type="checkbox" required> I understand rules compliance is mandatory.</label>
                                <label class="checkbox-item"><input type="checkbox" required> I understand organiser decisions are final.</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" id="prevBtn" class="btn-nav btn-prev" onclick="changeStep(-1)" style="display:none;">Previous</button>
                    <button type="button" id="nextBtn" class="btn-nav btn-next" onclick="changeStep(1)">Next Step</button>
                    <button type="button" id="payBtn" class="btn-pay" style="display:none;">PROCEED TO PAYMENT</button>
                </div>
            </form>
        </div>

        <div class="summary-section">
            <div class="summary-card">
                <h3 style="margin-top:0; font-family:'Russo One'; margin-bottom: 20px;">ORDER SUMMARY</h3>
                <div class="event-mini"><img id="eventImg" src="" class="mini-img"><div class="mini-info"><h4 id="eventTitle">Loading...</h4><p id="eventDate">-</p></div></div>
                <div class="voucher-container">
                    <div id="voucherInputGroup" class="voucher-input-group"><input type="text" id="voucherCode" placeholder="ENTER CODE"><button type="button" id="btnApply" class="btn-apply">APPLY</button></div>
                    <div id="activeVoucherBadge" class="active-voucher-badge"><span class="voucher-code-display" id="appliedCodeDisplay">CODE</span><button type="button" class="btn-remove-voucher" onclick="removeVoucher()"><i class="fas fa-times"></i></button></div>
                    <div id="voucherMsg" style="font-size:0.8rem; margin-top:8px; color:#ff4444; display:none;"></div>
                </div>
                <div class="price-row"><span>Reg. Fee</span><span id="displayPrice">RM 0.00</span></div>
                <div class="price-row" id="rowDiscount" style="display:none; color:#28a745;"><span>Discount</span><span>- RM <span id="discountVal">0.00</span></span></div>
                <div class="price-total"><span>TOTAL</span><span style="color:var(--brand-red)" id="finalTotal">RM 0.00</span></div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
        authDomain: "sea-mountain.firebaseapp.com",
        databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sea-mountain",
        storageBucket: "sea-mountain.firebasestorage.app",
        messagingSenderId: "812228825024",
        appId: "1:812228825024:web:717049c1a64b39c8a60225"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentStep = 1;
    let totalSteps = 3; // Initial fixed steps (Team, Racer, Medical)
    let originalPrice = 0;
    let finalAmount = 0;
    let currentUser = null;
    let currentVoucherCode = null;
    let customQuestionsData = []; 

    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || urlParams.get('id');

    onAuthStateChanged(auth, (user) => {
        if (user) { currentUser = user; } 
        else { alert("Please Log In."); window.location.href = "login.html"; }
    });

    if(eventId) {
        get(ref(db, 'events/' + eventId)).then((snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById('eventTitle').innerText = data.title;
                document.getElementById('eventDate').innerText = data.date;
                if(data.image_url) document.getElementById('eventImg').src = data.image_url;
                
                const now = new Date();
                const earlyEnd = data.early_bird_end ? new Date(data.early_bird_end) : null;
                const isEarly = earlyEnd && now <= earlyEnd;

                const catSelect = document.getElementById('raceCategory');
                catSelect.innerHTML = '<option value="" disabled selected>Select Category</option>';

                if(data.categories_data) {
                    data.categories_data.forEach(cat => {
                        let price = isEarly && cat.early_bird ? cat.early_bird : cat.price;
                        let label = `${cat.name} - RM ${price} ${isEarly ? '(Early Bird)' : ''}`;
                        let option = document.createElement('option');
                        option.value = cat.name;
                        option.text = label;
                        option.dataset.price = price;
                        catSelect.appendChild(option);
                    });
                } else {
                    let numPrice = parseFloat(data.price.replace(/[^0-9.]/g, '')) || 0;
                    let option = document.createElement('option');
                    option.value = "General";
                    option.text = `General Entry - RM ${numPrice}`;
                    option.dataset.price = numPrice;
                    catSelect.appendChild(option);
                }

                // --- BUILD DYNAMIC STEPS ---
                if (data.custom_questions && data.custom_questions.length > 0) {
                    customQuestionsData = data.custom_questions; 
                    buildDynamicUI(customQuestionsData);
                } else {
                    // Just default fixed steps + media + final
                    totalSteps = 5; 
                    renderStepper(5);
                    setupFixedEndSteps(4, 5);
                }
            }
        });
    }

    // --- DYNAMIC BUILDER LOGIC ---
    function buildDynamicUI(questions) {
        const dynContainer = document.getElementById('dynamicStepsContainer');
        dynContainer.innerHTML = "";
        
        let stepCount = 3; // Starts after Medical (Step 3)
        let currentGroupDiv = null;
        let currentCardBody = null;

        questions.forEach((q, index) => {
            if(q.type === 'header') {
                stepCount++; // New Header = New Step
                
                // Create New Page
                currentGroupDiv = document.createElement('div');
                currentGroupDiv.className = 'step-content';
                currentGroupDiv.id = `step${stepCount}`;
                
                const card = document.createElement('div');
                card.className = 'form-card';
                currentCardBody = document.createElement('div');
                currentCardBody.className = 'form-card-body';
                
                currentCardBody.innerHTML = `
                    <div class="step-header">
                        <h3 class="step-title">${stepCount}. ${q.question_text}</h3>
                        <p class="step-desc">Please complete this section.</p>
                    </div>
                `;
                
                card.appendChild(currentCardBody);
                currentGroupDiv.appendChild(card);
                dynContainer.appendChild(currentGroupDiv);
            } 
            else if (currentCardBody) {
                // Add Question to current Page
                let html = `<div class="form-group"><label>${q.question_text}</label>`;
                
                if (q.type === 'text') {
                    html += `<input type="text" id="customQ_${index}" class="form-control" ${q.required ? 'required' : ''}>`;
                } else if (q.type === 'datetime' || q.type === 'date') { 
                    // Changed: Support datetime-local
                    let type = q.type === 'datetime' ? 'datetime-local' : 'date';
                    html += `<input type="${type}" id="customQ_${index}" class="form-control" ${q.required ? 'required' : ''}>`;
                } else if (q.type === 'select') {
                    html += `<select id="customQ_${index}" class="form-control" ${q.required ? 'required' : ''}><option value="">Select...</option>`;
                    q.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
                    html += `</select>`;
                } else if (q.type === 'checkbox') {
                    html += `<div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" id="customQ_${index}" ${q.required ? 'required' : ''}> ${q.question_text}</label></div>`;
                }
                html += `</div>`;
                currentCardBody.insertAdjacentHTML('beforeend', html);
            }
        });

        // Set IDs for Media & Final Steps
        const mediaStepNum = stepCount + 1;
        const finalStepNum = stepCount + 2;
        totalSteps = finalStepNum;

        setupFixedEndSteps(mediaStepNum, finalStepNum);
        renderStepper(totalSteps);
    }

    function setupFixedEndSteps(mediaNum, finalNum) {
        // Update Media Section
        const mediaDiv = document.getElementById('step-media');
        mediaDiv.id = `step${mediaNum}`;
        document.getElementById('mediaTitle').innerText = `${mediaNum}. Media & Communication`;

        // Update Final Section
        const finalDiv = document.getElementById('step-final');
        finalDiv.id = `step${finalNum}`;
        document.getElementById('finalTitle').innerText = `${finalNum}. Final Acknowledgement`;
    }

    function renderStepper(total) {
        const wrapper = document.getElementById('stepperWrapper');
        wrapper.innerHTML = `<div class="stepper-line"></div>`;
        for(let i=1; i<=total; i++) {
            let activeClass = i === 1 ? 'active' : '';
            wrapper.innerHTML += `<div class="step-item ${activeClass}"><div class="step-circle">${i}</div></div>`;
        }
    }

    // --- NAVIGATION ---
    window.changeStep = function(n) {
        if (n === 1 && !validateStep(currentStep)) return;

        // Hide current
        document.getElementById(`step${currentStep}`).classList.remove('active');
        const items = document.querySelectorAll('.step-item');
        items[currentStep-1].classList.remove('active');
        if(n === 1) items[currentStep-1].classList.add('completed');

        currentStep += n;

        // Show next
        document.getElementById(`step${currentStep}`).classList.add('active');
        items[currentStep-1].classList.add('active');

        document.getElementById('prevBtn').style.display = (currentStep === 1) ? 'none' : 'inline-block';
        
        if (currentStep === totalSteps) {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('payBtn').style.display = 'block';
        } else {
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('payBtn').style.display = 'none';
        }
        window.scrollTo(0, 0);
    }

    function validateStep(step) {
        const stepDiv = document.getElementById(`step${step}`);
        const inputs = stepDiv.querySelectorAll('input[required], select[required], textarea[required]');
        let valid = true;
        inputs.forEach(input => {
            if (!input.checkValidity()) { input.reportValidity(); valid = false; return; }
        });
        return valid;
    }

    // --- STANDARD LOGIC (Voucher, Racers, Payment) ---
    window.updateRacersCount = function() {
        const catSelect = document.getElementById('raceCategory');
        const selectedOpt = catSelect.options[catSelect.selectedIndex];
        const price = parseFloat(selectedOpt.dataset.price) || 0;
        originalPrice = price;
        finalAmount = price; 
        if(currentVoucherCode) removeVoucher(); else updatePriceUI();

        const catName = catSelect.value;
        const container = document.getElementById('racersContainer');
        container.innerHTML = "";
        let count = catName.includes('24H') ? 4 : (catName.includes('12H') ? 2 : 1);

        for (let i = 1; i <= count; i++) {
            container.innerHTML += `
                <div class="racer-box">
                    <div class="racer-title">Racer ${i}</div>
                    <div class="form-group"><label>Full Name</label><input type="text" id="racer${i}_name" class="form-control" placeholder="As per ID/Passport" required></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                        <div><label>Gender</label><select class="form-control" id="racer${i}_gender" required><option value="">Select</option><option>Male</option><option>Female</option></select></div>
                        <div><label>Nationality</label><select class="form-control" id="racer${i}_nation" required><option value="Malaysian">Malaysian</option><option value="Foreigner">Foreigner</option></select></div>
                    </div>
                    <div class="form-group"><label>ID / Passport No.</label><input type="text" id="racer${i}_id" class="form-control" required></div>
                    <div class="form-group"><label>Email</label><input type="email" id="racer${i}_email" class="form-control" required></div>
                    <div class="form-group"><label>T-Shirt Size</label><select class="form-control" id="racer${i}_shirt" required><option value="">Select Size</option><option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option></select></div>
                    <div class="checkbox-group" style="padding:15px; background:none; border:none;"><label class="checkbox-item"><input type="checkbox" id="racer${i}_ack" required> I understand the wristband rule.</label></div>
                </div>`;
        }
    }

    document.getElementById('btnApply').addEventListener('click', () => {
        const code = document.getElementById('voucherCode').value.trim().toUpperCase();
        if(!code) return;
        get(ref(db, 'vouchers/' + code)).then((snap) => {
            if(snap.exists()) {
                const v = snap.val();
                let disc = (v.type === 'percent') ? originalPrice * (v.value/100) : parseFloat(v.value);
                if(disc > originalPrice) disc = originalPrice;
                finalAmount = originalPrice - disc;
                document.getElementById('voucherInputGroup').style.display = 'none';
                document.getElementById('activeVoucherBadge').style.display = 'flex';
                document.getElementById('appliedCodeDisplay').innerText = code;
                document.getElementById('rowDiscount').style.display = 'flex';
                document.getElementById('discountVal').innerText = disc.toFixed(2);
                document.getElementById('voucherMsg').style.display = 'none';
                currentVoucherCode = code;
                updatePriceUI();
            } else {
                document.getElementById('voucherMsg').style.display = 'block';
                document.getElementById('voucherMsg').innerText = "Invalid Code";
            }
        });
    });

    window.removeVoucher = function() {
        currentVoucherCode = null;
        finalAmount = originalPrice;
        document.getElementById('voucherInputGroup').style.display = 'flex';
        document.getElementById('activeVoucherBadge').style.display = 'none';
        document.getElementById('rowDiscount').style.display = 'none';
        document.getElementById('voucherCode').value = "";
        updatePriceUI();
    }

    function updatePriceUI() {
        document.getElementById('displayPrice').innerText = "RM " + originalPrice.toFixed(2);
        document.getElementById('finalTotal').innerText = "RM " + finalAmount.toFixed(2);
    }

    document.getElementById('payBtn').addEventListener('click', () => {
        if(currentStep !== totalSteps || !validateStep(totalSteps)) { alert("Please complete all steps."); return; }

        let racers = [];
        const cat = document.getElementById('raceCategory').value;
        let count = cat.includes('24H') ? 4 : (cat.includes('12H') ? 2 : 1);
        for (let i = 1; i <= count; i++) {
            racers.push({
                name: document.getElementById(`racer${i}_name`).value,
                gender: document.getElementById(`racer${i}_gender`).value,
                nation: document.getElementById(`racer${i}_nation`).value,
                id: document.getElementById(`racer${i}_id`).value,
                email: document.getElementById(`racer${i}_email`).value,
                shirt: document.getElementById(`racer${i}_shirt`).value
            });
        }

        let customAnswers = [];
        if (customQuestionsData.length > 0) {
            customQuestionsData.forEach((q, index) => {
                if(q.type === 'header') return; 
                let ans = "";
                if (q.type === 'checkbox') ans = document.getElementById(`customQ_${index}`).checked ? "Yes" : "No";
                else ans = document.getElementById(`customQ_${index}`).value;
                customAnswers.push({ question: q.question_text, answer: ans });
            });
        }

        const formData = {
            event_code: eventId,
            event_name: document.getElementById('eventTitle').innerText,
            teamName: document.getElementById('teamName').value,
            captainName: document.getElementById('captainName').value,
            captainEmail: document.getElementById('captainEmail').value,
            captainMobile: document.getElementById('captainMobile').value,
            teamCountry: document.getElementById('teamCountry').value,
            category: cat,
            emergencyName: document.getElementById('emergencyName').value,
            racers: racers,
            custom_answers: customAnswers, 
            medical: {
                blood: document.getElementById('medBlood').value,
                condition: document.getElementById('medCondition').value,
                meds: document.getElementById('medMeds').value,
                allergy: document.getElementById('medAllergy').value,
                notes: document.getElementById('medNotes').value
            },
            amountPaid: finalAmount.toFixed(2),
            voucherUsed: currentVoucherCode || "NONE",
            registration_time: new Date().toLocaleString(),
            status: "Pending Payment",
            first_name: document.getElementById('captainName').value,
            email: document.getElementById('captainEmail').value,
            userId: currentUser.uid
        };

        sessionStorage.setItem('tempRegistration', JSON.stringify(formData));
        window.location.href = "payment.html";
    });
</script>
</body>
</html>
