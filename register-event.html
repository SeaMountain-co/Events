<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Event - Sea Mountain</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-red: #ff0000; --bg-dark: #0f1014; --card-bg: #1a1c23; --text: #ffffff; }
        * { box-sizing: border-box; }
        
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding-bottom: 50px; }
        
        /* HEADER */
        .header { padding: 20px 5%; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-family: 'Russo One'; font-size: 1.2rem; color: #fff; text-decoration: none; }
        .logo span { color: var(--brand-red); }

        .container { max-width: 1200px; margin: 40px auto; display: flex; gap: 40px; padding: 0 5%; align-items: flex-start; }
        
        /* LEFT COLUMN: FORM */
        .form-section { flex: 1.6; width: 100%; }
        h2 { font-family: 'Russo One'; text-transform: uppercase; margin-bottom: 25px; font-size: 1.5rem; border-bottom: 2px solid var(--brand-red); display: inline-block; padding-bottom: 5px; margin-top: 0; }
        
        .form-card { background: var(--card-bg); padding: 35px; border-radius: 15px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 20px; width: 100%; } 
        
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        
        /* STANDARDIZED INPUTS */
        .form-control { 
            width: 100%; height: 50px; padding: 0 15px; 
            background: #0a0b0e; border: 1px solid #444; color: #fff; border-radius: 8px; 
            font-size: 0.95rem; font-family: 'Montserrat'; outline: none; transition: 0.3s; 
            appearance: none; 
        }
        .form-control:focus { border-color: var(--brand-red); box-shadow: 0 0 0 3px rgba(255,0,0,0.1); background: #111; }
        
        select.form-control {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
            cursor: pointer;
        }

        .form-row { display: flex; gap: 20px; width: 100%; } 
        .form-row .form-group { flex: 1; }

        .section-label { color: var(--brand-red); font-weight: 800; margin-top: 30px; margin-bottom: 20px; text-transform: uppercase; border-top: 1px solid #333; padding-top: 25px; font-size: 1rem; letter-spacing: 1px; }

        .terms-group { display: flex; align-items: flex-start; gap: 10px; margin-top: 25px; font-size: 0.9rem; color: #888; background: #15161b; padding: 15px; border-radius: 8px; }
        .terms-group input { margin-top: 3px; accent-color: var(--brand-red); width: 18px; height: 18px; cursor: pointer; }
        .terms-group a { color: var(--brand-red); text-decoration: none; font-weight: bold; }

        /* RIGHT COLUMN: SUMMARY */
        .summary-section { flex: 1; width: 100%; position: sticky; top: 100px; height: fit-content; }
        .summary-card { background: #fff; color: #000; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .summary-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: repeating-linear-gradient(45deg, #ff0000, #ff0000 10px, #000 10px, #000 20px); }

        .event-mini-info { display: flex; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .mini-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .mini-details h4 { margin: 0 0 5px 0; font-family: 'Russo One'; font-size: 1.1rem; text-transform: uppercase; line-height: 1.2; }
        .mini-details p { margin: 0; color: #666; font-size: 0.85rem; font-weight: 600; }

        .voucher-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .voucher-input { flex: 1; padding: 12px; border: 2px dashed #ccc; border-radius: 6px; text-transform: uppercase; font-weight: bold; text-align: center; font-size: 1rem; letter-spacing: 2px; height: 50px; }
        
        .btn-apply { background: #000; color: #fff; border: none; padding: 0 25px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; height: 50px; }
        .btn-apply:hover { background: #333; }
        
        .btn-remove { background: #d9534f; color: #fff; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; display: none; transition: 0.3s; height: 50px; }
        .btn-remove:hover { background: #c9302c; }

        .price-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; color: #555; font-weight: 500; }
        .price-row.total { font-size: 1.6rem; font-weight: 900; color: #000; margin-top: 25px; border-top: 2px solid #000; padding-top: 15px; align-items: center; }
        .discount-text { color: #28a745; font-weight: bold; }

        .btn-pay { background: var(--brand-red); color: #fff; width: 100%; padding: 18px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(255,0,0,0.4); }
        .btn-pay:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255,0,0,0.6); }

        @media (max-width: 900px) { 
            .container { flex-direction: column; padding: 0 15px; } 
            .form-card { padding: 20px; }
            .form-row { flex-direction: column; gap: 0; } 
            .form-group { margin-bottom: 15px; }
            .summary-section { position: relative; top: 0; margin-top: 30px; order: 2; }
            .form-section { order: 1; }
        }

        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="logo">SEA<span>MOUNTAIN</span></a>
        <a href="index.html" style="color:#aaa; text-decoration:none; font-weight:bold; font-size: 0.9rem;"><i class="fas fa-times"></i> CANCEL</a>
    </div>

    <div class="container">
        
        <div class="form-section">
            <h2>Participant Details</h2>
            <div class="form-card">
                <form id="regForm">
                    <div class="section-label" style="margin-top:0;">Personal Information</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="firstName" class="form-control" placeholder="Enter First Name" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName" class="form-control" placeholder="Enter Last Name" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>IC / Passport No.</label>
                            <input type="text" id="ic" class="form-control" placeholder="e.g. 901010-10-1234" required>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dob" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="gender" class="form-control" required>
                                <option value="" disabled selected>Select Gender</option>
                                <option>Male</option><option>Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phone" class="form-control" placeholder="+60..." required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>

                    <div class="section-label">Mailing Address</div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="address" class="form-control" placeholder="Street address, Unit..." required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="city" class="form-control" placeholder="Enter City" required>
                        </div>
                        <div class="form-group">
                            <label>Postcode</label>
                            <input type="text" id="postcode" class="form-control" placeholder="Poscode" required>
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <select id="country" class="form-control">
                            <option value="my">Malaysia</option>
                            <option value="sg">Singapore</option>
                            <option value="id">Indonesia</option>
                            <option value="th">Thailand</option>
                            <option value="bn">Brunei</option>
                            <option value="vn">Vietnam</option>
                            <option value="ph">Philippines</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-label">Race Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Race Category</label>
                            <select id="category" class="form-control" required>
                                <option value="" disabled selected>Loading Categories...</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label>T-Shirt Size</label>
                            <select id="tshirt" class="form-control" required>
                                <option value="" disabled selected>Select Size</option>
                                <option value="xs">XS</option><option value="s">S</option><option value="m">M</option><option value="l">L</option><option value="xl">XL</option><option value="xxl">XXL</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-label">Emergency Contact</div>
                    <div class="form-group">
                        <label>Name Emergency Contact</label>
                        <input type="text" id="emergencyName" class="form-control" placeholder="Name of next of kin" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number Emergency Contact</label>
                        <input type="tel" id="emergencyPhone" class="form-control" placeholder="+60..." required>
                    </div>

                    <div class="terms-group">
                        <input type="checkbox" id="terms" required>
                        <label for="terms">I agree to the <a href="#">terms and conditions</a> and acknowledge the <a href="#">privacy policy</a>.</label>
                    </div>

                </form>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-card">
                <h3 style="margin-top:0; font-family:'Russo One'; margin-bottom: 25px;">ORDER SUMMARY</h3>
                
                <div class="event-mini-info">
                    <img id="eventImg" src="" class="mini-img">
                    <div class="mini-details">
                        <h4 id="eventTitle">Loading Event...</h4>
                        <p id="eventDate"><i class="far fa-calendar-alt"></i> -</p>
                    </div>
                </div>

                <label style="font-size:0.8rem; font-weight:bold; color:#555; display:block; margin-bottom:8px;">HAVE A PROMO CODE?</label>
                <div class="voucher-box">
                    <input type="text" id="voucherCode" class="voucher-input" placeholder="CODE">
                    <button type="button" id="btnApply" class="btn-apply">APPLY</button>
                    <button type="button" id="btnRemove" class="btn-remove" title="Remove Voucher"><i class="fas fa-times"></i></button>
                </div>
                
                <div id="voucherMsg" style="font-size:0.8rem; margin-top:-15px; margin-bottom:15px; display:none; font-weight: 600;"></div>

                <div class="price-row">
                    <span>Registration Fee</span>
                    <span id="displayPrice">RM 0.00</span>
                </div>
                <div class="price-row" id="rowDiscount" style="display:none;">
                    <span class="discount-text">Discount (<span id="appliedCode"></span>)</span>
                    <span class="discount-text">- RM <span id="discountVal">0.00</span></span>
                </div>
                <div class="price-row">
                    <span>Processing Fee</span>
                    <span>RM 0.00</span>
                </div>

                <div class="price-row total">
                    <span>TOTAL</span>
                    <span style="color:var(--brand-red)" id="finalTotal">RM 0.00</span>
                </div>

                <button type="button" id="payBtn" class="btn-pay">PROCEED TO PAYMENT</button>
                <p style="text-align:center; font-size:0.75rem; color:#888; margin-top:15px;">
                    Next Step: Secure Payment
                </p>
            </div>
        </div>

    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, push, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // CONFIG FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
        authDomain: "sea-mountain.firebaseapp.com",
        databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sea-mountain",
        storageBucket: "sea-mountain.firebasestorage.app",
        messagingSenderId: "812228825024",
        appId: "1:812228825024:web:717049c1a64b39c8a60225"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Global Variables
    let originalPrice = 0;
    let finalAmount = 0;
    let discountAmount = 0;
    let currentUser = null;
    let currentVoucherCode = null;
    let eventDataGlobal = null; // Store event data globally for reference
    
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || urlParams.get('id');

    // 1. CHECK AUTH
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('email').value = user.email; 
        } else {
            alert("Please Log In first.");
            window.location.href = "login.html";
        }
    });

    // 2. LOAD EVENT DATA (UPDATED: LOGIC PRICING DINAMIK)
    if(eventId) {
        get(ref(db, 'events/' + eventId)).then((snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                eventDataGlobal = data; // Simpan data untuk rujukan
                
                document.getElementById('eventTitle').innerText = data.title;
                document.getElementById('eventDate').innerHTML = `<i class="far fa-calendar-alt"></i> ${data.date}`;
                if(data.image_url) document.getElementById('eventImg').src = data.image_url;
                
                // Parse Basic Price (Fallback)
                let priceString = String(data.price).replace(/[^0-9.]/g, ''); 
                originalPrice = parseFloat(priceString) || 0;
                finalAmount = originalPrice;

                updatePriceUI();

                // --- UPDATED: POPULATE CATEGORY DROPDOWN WITH PRICES ---
                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>'; 

                if (data.categories_data && Array.isArray(data.categories_data)) {
                    // NEW: Gunakan Data Kategori Baru (Dengan Harga)
                    data.categories_data.forEach((cat, index) => {
                        const priceToUse = isEarlyBird(data.early_bird_end) ? (cat.early_bird || cat.price) : cat.price;
                        const label = `${cat.name} - RM ${priceToUse}`;
                        
                        const option = document.createElement('option');
                        option.value = index; // Guna index array sebagai value sementara
                        option.text = label;
                        option.dataset.price = priceToUse; // Simpan harga dalam atribut data
                        option.dataset.name = cat.name;
                        categorySelect.appendChild(option);
                    });
                } else if (data.categories) {
                    // OLD: Fallback Struktur Lama
                    let categories = Array.isArray(data.categories) ? data.categories : data.categories.split(',');
                    categories.forEach(cat => {
                        const cleanCat = cat.trim();
                        if(cleanCat) {
                            const option = document.createElement('option');
                            option.value = cleanCat;
                            option.text = cleanCat;
                            option.dataset.price = originalPrice; // Guna harga asal event
                            option.dataset.name = cleanCat;
                            categorySelect.appendChild(option);
                        }
                    });
                } else {
                    categorySelect.innerHTML += '<option value="General" data-price="' + originalPrice + '" data-name="General">General Entry</option>';
                }
                
                // Listener bila user tukar kategori -> Update Harga
                categorySelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const newPrice = parseFloat(selectedOption.dataset.price) || 0;
                    
                    originalPrice = newPrice; // Update harga asal
                    discountAmount = 0; // Reset diskaun bila harga berubah
                    finalAmount = originalPrice; // Reset total
                    
                    // Reset Voucher UI
                    document.getElementById('voucherCode').value = "";
                    document.getElementById('voucherCode').disabled = false;
                    document.getElementById('btnApply').style.display = "inline-block";
                    document.getElementById('btnRemove').style.display = "none";
                    document.getElementById('rowDiscount').style.display = "none";
                    currentVoucherCode = null;

                    updatePriceUI();
                });

            } else {
                alert("Event not found.");
                window.location.href = "index.html";
            }
        });
    } else {
        alert("No event selected.");
        window.location.href = "index.html";
    }

    // Helper: Check Early Bird Date
    function isEarlyBird(endDateString) {
        if (!endDateString) return false;
        const now = new Date();
        const end = new Date(endDateString);
        end.setHours(23, 59, 59); // Sampai hujung hari
        return now <= end;
    }

    // 3. VOUCHER LOGIC
    document.getElementById('btnApply').addEventListener('click', () => {
        const codeInput = document.getElementById('voucherCode');
        const code = codeInput.value.trim().toUpperCase();
        const msg = document.getElementById('voucherMsg');

        if(!code) return;

        get(ref(db, 'vouchers/' + code)).then((snapshot) => {
            if(snapshot.exists()) {
                const voucher = snapshot.val();
                
                if (voucher.eventId && voucher.eventId !== "ALL" && voucher.eventId !== eventId) {
                    showError(msg, "Code not valid for this event.");
                    return;
                }

                const now = new Date();
                const expiryDate = new Date(voucher.expiry);
                expiryDate.setHours(23, 59, 59);

                if (now > expiryDate) {
                    showError(msg, "Voucher has expired.");
                    return;
                }

                const used = voucher.used ? parseInt(voucher.used) : 0;
                const limit = voucher.limit ? parseInt(voucher.limit) : 0;

                if (limit > 0 && used >= limit) {
                    showError(msg, "Voucher fully redeemed.");
                    return;
                }

                if (voucher.type === 'percent') {
                    discountAmount = originalPrice * (parseFloat(voucher.value) / 100);
                } else {
                    discountAmount = parseFloat(voucher.value);
                }

                if(discountAmount > originalPrice) discountAmount = originalPrice;
                finalAmount = originalPrice - discountAmount;

                document.getElementById('rowDiscount').style.display = 'flex';
                document.getElementById('discountVal').innerText = discountAmount.toFixed(2);
                document.getElementById('appliedCode').innerText = code;
                
                msg.style.display = 'block';
                msg.style.color = '#28a745';
                msg.innerText = "Voucher Applied!";
                
                codeInput.disabled = true;
                document.getElementById('btnApply').style.display = 'none';
                document.getElementById('btnRemove').style.display = 'inline-block';

                currentVoucherCode = code; 
                updatePriceUI();

            } else {
                showError(msg, "Invalid Voucher Code.");
            }
        });
    });

    function showError(element, text) {
        element.style.display = 'block';
        element.style.color = '#d9534f';
        element.innerText = text;
        discountAmount = 0;
        finalAmount = originalPrice;
        currentVoucherCode = null;
        document.getElementById('rowDiscount').style.display = 'none';
        updatePriceUI();
    }

    document.getElementById('btnRemove').addEventListener('click', () => {
        const codeInput = document.getElementById('voucherCode');
        const msg = document.getElementById('voucherMsg');
        discountAmount = 0;
        finalAmount = originalPrice;
        currentVoucherCode = null;
        codeInput.value = "";
        codeInput.disabled = false;
        msg.style.display = 'none';
        document.getElementById('rowDiscount').style.display = 'none';
        document.getElementById('btnApply').style.display = 'inline-block';
        document.getElementById('btnRemove').style.display = 'none';
        updatePriceUI();
    });

    function updatePriceUI() {
        document.getElementById('displayPrice').innerText = "RM " + originalPrice.toFixed(2);
        document.getElementById('finalTotal').innerText = "RM " + finalAmount.toFixed(2);
    }

    // 4. PROCEED TO PAYMENT
    document.getElementById('payBtn').addEventListener('click', () => {
        const form = document.getElementById('regForm');
        
        if(!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Dapatkan nama kategori sebenar dari dropdown (bukan value/index)
        const categorySelect = document.getElementById('category');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryName = selectedOption.dataset.name || categorySelect.value;

        const tempRegData = {
            userId: currentUser.uid, 
            event_code: eventId,
            event_name: document.getElementById('eventTitle').innerText,
            
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            ic: document.getElementById('ic').value,
            dob: document.getElementById('dob').value,
            gender: document.getElementById('gender').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            postcode: document.getElementById('postcode').value,
            country: document.getElementById('country').value,
            
            category: categoryName, // Simpan Nama Kategori
            tshirt_size: document.getElementById('tshirt').value,
            
            emergencyName: document.getElementById('emergencyName').value,
            emergencyPhone: document.getElementById('emergencyPhone').value,
            
            amountPaid: finalAmount.toFixed(2),
            voucherUsed: currentVoucherCode || "NONE",
            registration_time: new Date().toLocaleString(),

            status: "Pending Payment"  // Set status awal supaya Admin Dashboard tak pening
        };

        if (currentVoucherCode && currentVoucherCode !== "NONE") {
            const voucherRef = ref(db, `vouchers/${currentVoucherCode}/used`);
            runTransaction(voucherRef, (currentUsed) => {
                return (currentUsed || 0) + 1;
            }).then(() => {
                sessionStorage.setItem('tempRegistration', JSON.stringify(tempRegData));
                window.location.href = "payment.html";
            }).catch((err) => {
                alert("Error processing voucher.");
            });
        } else {
            sessionStorage.setItem('tempRegistration', JSON.stringify(tempRegData));
            window.location.href = "payment.html";
        }
    });

</script>

</body>
</html>
