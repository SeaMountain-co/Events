<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Assignment - Timing System</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* --- TEMA DASHBOARD --- */
        :root { --bg: #0f1014; --card: #1a1c23; --accent: #00d2ff; --text: #fff; --success: #2ecc71; --error: #e74c3c; --pending: #f39c12; }
        * { box-sizing: border-box; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; min-height: 100vh; }

        /* HEADER */
        .header { padding: 15px 30px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -1px; }
        .logo span { color: var(--accent); }
        .back-btn { color: #aaa; text-decoration: none; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .back-btn:hover { color: #fff; }

        /* CONTAINER */
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        
        /* TOP SECTION (ASSIGNMENT) */
        .assign-section { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; margin-bottom: 50px; }

        /* EVENT SELECTOR (ATAS) */
        .top-bar { margin-bottom: 20px; }
        .event-select { width: 100%; max-width: 500px; padding: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 1rem; outline: none; transition: 0.3s; }
        .event-select:focus { border-color: var(--accent); }

        /* LEFT PANEL: SCANNER */
        .scan-card { background: var(--card); padding: 40px; border-radius: 15px; border: 1px solid #333; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .scan-icon { font-size: 5rem; color: var(--accent); margin-bottom: 30px; animation: pulse 2s infinite; }
        .scan-status { font-family: 'Russo One'; font-size: 1.5rem; margin-bottom: 15px; color: #fff; }
        .scan-input { 
            width: 100%; padding: 20px; background: #000; border: 2px solid #444; color: var(--accent); 
            font-size: 1.2rem; text-align: center; border-radius: 10px; font-weight: bold; outline: none; letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: 15px; transition: 0.3s;
        }
        .scan-input:focus { border-color: var(--accent); box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); }
        .scan-hint { color: #666; font-size: 0.85rem; }

        /* RIGHT PANEL: FORM */
        .form-card { background: var(--card); padding: 40px; border-radius: 15px; border: 1px solid #333; opacity: 0.3; pointer-events: none; transition: 0.3s; position: relative; }
        .form-card.active { opacity: 1; pointer-events: all; border-color: var(--accent); }

        .tag-badge { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; font-weight: bold; padding: 5px 10px; border-radius: 4px; display: none; text-transform: uppercase; }
        .tag-new { background: var(--success); color: #000; }
        .tag-exist { background: var(--pending); color: #000; }

        .form-group { margin-bottom: 25px; }
        .label { display: block; margin-bottom: 10px; color: #888; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .input-box { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; font-family: 'Montserrat'; font-size: 1rem; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: var(--accent); }
        .input-readonly { background: #151515; color: #666; border-color: #222; cursor: default; }

        .btn-save { width: 100%; padding: 18px; background: var(--success); border: none; color: #000; font-weight: 800; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-save:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(46, 204, 113, 0.2); }
        .btn-cancel { background: transparent; border: none; color: #666; margin-top: 15px; cursor: pointer; text-decoration: underline; font-size: 0.9rem; }

        /* TABLE SECTION */
        .table-section { background: var(--card); border-radius: 15px; border: 1px solid #333; padding: 20px; overflow: hidden; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-input { padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 5px; width: 300px; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 15px; background: #111; color: #888; text-transform: uppercase; font-size: 0.8rem; border-bottom: 2px solid #333; }
        .data-table td { padding: 15px; border-bottom: 1px solid #222; font-size: 0.9rem; }
        .data-table tr:hover { background: #222; }

        .status-linked { color: var(--success); font-weight: bold; font-size: 0.8rem; border: 1px solid var(--success); padding: 3px 8px; border-radius: 4px; display: inline-block; }
        .status-none { color: #666; font-weight: bold; font-size: 0.8rem; border: 1px solid #444; padding: 3px 8px; border-radius: 4px; display: inline-block; }

        .btn-unlink { background: #e74c3c; color: #fff; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .btn-unlink:hover { background: #c0392b; }

        /* SELECT2 DARK THEME OVERRIDE */
        .select2-container--default .select2-selection--single { background-color: #000; border: 1px solid #444; height: 50px; border-radius: 8px; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: #fff; line-height: 50px; padding-left: 15px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 48px; }
        .select2-dropdown { background-color: #1a1c23; border: 1px solid #444; color: #fff; }
        .select2-search__field { background-color: #000 !important; color: #fff !important; border: 1px solid #444 !important; }
        .select2-results__option--highlighted[aria-selected] { background-color: var(--accent); color: #000; }
        .select2-results__option[aria-selected=true] { background-color: #333; }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @media (max-width: 900px) { .assign-section { grid-template-columns: 1fr; } .scan-card { padding: 30px; margin-bottom: 20px; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">SEA <span>TIMING</span></div>
        <a href="admin-dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <div class="container">
        
        <div class="top-bar">
            <select id="eventSelector" class="event-select">
                <option value="" disabled selected>-- Select Event First --</option>
                <option value="loading">Loading Events...</option>
            </select>
        </div>

        <div class="assign-section">
            <div class="scan-card">
                <i class="fas fa-wifi scan-icon"></i>
                <div class="scan-status">READY TO SCAN</div>
                <input type="text" id="rfidInput" class="scan-input" placeholder="Click & Tap Card" autocomplete="off" autofocus>
                <p class="scan-hint">Ensure cursor is blinking inside the box before scanning.</p>
            </div>

            <div id="assignForm" class="form-card">
                <div id="cardTypeTag" class="tag-badge">NEW CARD</div>
                
                <div class="form-group">
                    <label class="label">Card UID</label>
                    <input type="text" id="displayUID" class="input-box input-readonly" readonly>
                </div>

                <div class="form-group">
                    <label class="label">Select Participant</label>
                    <select id="participantSelect" style="width: 100%;"><option></option></select>
                </div>

                <div class="form-group">
                    <label class="label">Assign BIB Number</label>
                    <input type="text" id="bibInput" class="input-box" placeholder="e.g. A1001">
                </div>

                <div class="form-group">
                    <label class="label">Category</label>
                    <input type="text" id="catDisplay" class="input-box input-readonly" readonly>
                </div>

                <div class="form-group" style="display:none;" id="eventDisplayGroup">
                    <label class="label">Event ID</label>
                    <input type="text" id="eventDisplay" class="input-box input-readonly" readonly>
                </div>

                <button id="btnSave" class="btn-save">LINK CARD & SAVE</button>
                <div style="text-align:center;">
                    <button onclick="resetForm()" class="btn-cancel">Cancel / Reset (ESC)</button>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h3 style="margin:0;">Manage Participants List</h3>
                <input type="text" id="searchInput" class="search-input" placeholder="Search by name, BIB, Event or Card ID...">
            </div>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="color:var(--accent);">EVENT</th>
                            <th>BIB</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Card Status</th>
                            <th>Card ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="participantTableBody">
                        <tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">Select an event to load list.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
            authDomain: "sea-mountain.firebaseapp.com",
            databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sea-mountain",
            storageBucket: "sea-mountain.firebasestorage.app",
            messagingSenderId: "812228825024",
            appId: "1:812228825024:web:717049c1a64b39c8a60225"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let participantsData = []; 
        let rfidMap = {}; 

        // 1. INIT SELECT2
        $(document).ready(function() {
            $('#participantSelect').select2({ placeholder: "Search name, email, or IC...", allowClear: true });

            $('#participantSelect').on('select2:select', function (e) {
                const userId = e.params.data.id;
                const user = participantsData.find(p => p.id === userId);
                if(user) {
                    document.getElementById('catDisplay').value = user.category || "-";
                    // Papar Event ID jika user pilih "ALL EVENTS"
                    document.getElementById('eventDisplay').value = user.eventId || "-";
                    if(user.bib) document.getElementById('bibInput').value = user.bib;
                }
            });
        });

        // 2. LOAD EVENTS (Tambah Option 'ALL')
        const eventSelect = document.getElementById('eventSelector');
        onValue(ref(db, 'events'), (snapshot) => {
            eventSelect.innerHTML = '<option value="" disabled selected>-- Select Event First --</option>';
            // Tambah Pilihan ALL EVENTS
            eventSelect.innerHTML += '<option value="all" style="font-weight:bold; color:#00d2ff;">ALL EVENTS (VIEW & MANAGE)</option>';
            
            if(snapshot.exists()){
                Object.entries(snapshot.val()).forEach(([key, ev]) => {
                    eventSelect.innerHTML += `<option value="${key}">${ev.title}</option>`;
                });
            }
        });

        // 3. LOAD PARTICIPANTS (Logik 'All' ditambah)
        eventSelect.addEventListener('change', function() {
            loadParticipants(this.value);
            document.getElementById('rfidInput').focus();
        });

        function loadParticipants(eventId) {
            let dbRef;
            
            // Kalau pilih ALL, ambil root 'registrations'
            if(eventId === 'all') {
                dbRef = ref(db, 'registrations');
            } else {
                dbRef = ref(db, `registrations/${eventId}`);
            }

            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                participantsData = [];
                rfidMap = {};
                
                $('#participantSelect').empty().trigger("change");

                if(data) {
                    // Jika ALL EVENTS, structure data: { eventA: {users...}, eventB: {users...} }
                    if(eventId === 'all') {
                        Object.entries(data).forEach(([evId, users]) => {
                            Object.entries(users).forEach(([userId, p]) => {
                                processUserData(userId, p, evId);
                            });
                        });
                    } 
                    // Jika SINGLE EVENT, structure data: { user1: ..., user2: ... }
                    else {
                        Object.entries(data).forEach(([userId, p]) => {
                            processUserData(userId, p, eventId);
                        });
                    }
                }
                
                $('#participantSelect').trigger('change');
                renderTable(participantsData);
            });
        }

        // Helper untuk proses data (supaya tak ulang kod)
        function processUserData(userId, p, evId) {
            // Tambah eventId ke dalam object user untuk rujukan
            const userObj = { id: userId, eventId: evId, ...p };
            participantsData.push(userObj);
            
            // Map RFID (Global Check)
            if(p.rfid_tag) {
                rfidMap[p.rfid_tag] = { id: userId, name: p.first_name + " " + p.last_name, eventId: evId };
            }

            // Dropdown Label (Ada Nama Event kalau pilih ALL)
            const label = `${p.first_name} ${p.last_name} [${evId.toUpperCase()}] - ${p.category}`;
            const newOption = new Option(label, userId, false, false);
            $('#participantSelect').append(newOption);
        }

        // 4. RENDER TABLE & SEARCH (Tambah Column Event)
        function renderTable(data) {
            const tbody = document.getElementById('participantTableBody');
            tbody.innerHTML = "";

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No participants found.</td></tr>';
                return;
            }

            data.forEach(p => {
                const isLinked = !!p.rfid_tag;
                const statusHtml = isLinked 
                    ? `<span class="status-linked">LINKED</span>` 
                    : `<span class="status-none">NO CARD</span>`;
                
                const actionHtml = isLinked 
                    ? `<button class="btn-unlink" onclick="unlinkCard('${p.id}', '${p.eventId}')"><i class="fas fa-unlink"></i> Unlink</button>` 
                    : `<span style="color:#666;">-</span>`;

                const row = `
                    <tr>
                        <td style="color:var(--accent); font-weight:bold; text-transform:uppercase;">${p.eventId}</td>
                        <td style="font-weight:bold;">${p.bib || '-'}</td>
                        <td>${p.first_name} ${p.last_name || ''}</td>
                        <td>${p.category}</td>
                        <td>${statusHtml}</td>
                        <td style="font-family:monospace; color:#888;">${p.rfid_tag || '-'}</td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            const term = e.target.value.toLowerCase();
            const filtered = participantsData.filter(p => 
                (p.first_name + " " + p.last_name).toLowerCase().includes(term) ||
                (p.bib || "").toLowerCase().includes(term) ||
                (p.eventId || "").toLowerCase().includes(term) || // Boleh search by Event ID
                (p.rfid_tag || "").toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

        // 5. UNLINK FUNCTION (Kena pass eventId sebab mungkin 'All Events' dipilih)
        window.unlinkCard = function(userId, userEventId) {
            if(confirm("Are you sure you want to unlink (remove) the card from this user?")) {
                const updates = {};
                updates[`registrations/${userEventId}/${userId}/rfid_tag`] = null; 
                
                update(ref(db), updates).then(() => {
                    alert("Card Unlinked Successfully!");
                }).catch(err => alert("Error: " + err.message));
            }
        }

        // 6. RFID SCAN LOGIC
        const rfidInput = document.getElementById('rfidInput');
        const scanIcon = document.querySelector('.scan-icon');
        
        rfidInput.addEventListener('change', function() {
            handleScan(this.value.trim());
        });

        function handleScan(code) {
            if(!code) return;
            if(eventSelect.value === "") { alert("Please select an event first!"); rfidInput.value = ""; return; }

            const form = document.getElementById('assignForm');
            const uidField = document.getElementById('displayUID');
            const statusTag = document.getElementById('cardTypeTag');
            
            scanIcon.style.color = '#2ecc71';
            setTimeout(() => scanIcon.style.color = '#00d2ff', 500);

            form.classList.add('active');
            uidField.value = code;

            if (rfidMap[code]) {
                const existingUser = rfidMap[code];
                statusTag.innerText = "EXISTING CARD";
                statusTag.className = "tag-badge tag-exist";
                statusTag.style.display = "block";
                $('#participantSelect').val(existingUser.id).trigger('change');
            } else {
                statusTag.innerText = "NEW CARD";
                statusTag.className = "tag-badge tag-new";
                statusTag.style.display = "block";
                $('#participantSelect').val(null).trigger('change');
                document.getElementById('bibInput').value = "";
                document.getElementById('catDisplay').value = "";
                document.getElementById('eventDisplay').value = "";
            }
            rfidInput.value = "";
        }

        // 7. SAVE DATA (Updated Logic for All Events)
        document.getElementById('btnSave').addEventListener('click', () => {
            const dropdownValue = eventSelect.value;
            const rfid = document.getElementById('displayUID').value;
            const userId = $('#participantSelect').val();
            const bib = document.getElementById('bibInput').value;

            if(!userId || !rfid || !bib) {
                alert("Please fill in all fields (User & BIB).");
                return;
            }

            // Cari user dalam data array untuk dapatkan Event ID sebenar
            const selectedUser = participantsData.find(p => p.id === userId);
            
            // Jika dropdown "ALL", guna eventId dari user. Jika specific, guna dropdown value.
            const targetEventId = selectedUser ? selectedUser.eventId : dropdownValue;

            if(!targetEventId || targetEventId === 'all') {
                alert("Error: Cannot determine Event ID for this user.");
                return;
            }

            const updates = {};
            updates[`registrations/${targetEventId}/${userId}/rfid_tag`] = rfid;
            updates[`registrations/${targetEventId}/${userId}/bib`] = bib;

            update(ref(db), updates).then(() => {
                alert("SUCCESS! Card Assigned.");
                resetForm();
            }).catch((err) => {
                alert("Error: " + err.message);
            });
        });

        // Helper: Reset Form
        window.resetForm = function() {
            document.getElementById('assignForm').classList.remove('active');
            document.getElementById('displayUID').value = "";
            document.getElementById('cardTypeTag').style.display = "none";
            $('#participantSelect').val(null).trigger('change');
            document.getElementById('bibInput').value = "";
            document.getElementById('eventDisplay').value = "";
            document.getElementById('rfidInput').focus(); 
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") { resetForm(); }
        });

    </script>
</body>
</html>
