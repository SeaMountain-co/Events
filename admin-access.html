<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Client Access - Sea Mountain</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        body { background-color: #111; color: #fff; font-family: 'Montserrat', sans-serif; padding: 20px; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 25px; }
        .logo { font-family: 'Russo One'; color: #ff0000; font-size: 1.3rem; text-decoration: none;}
        .btn-nav { color: #888; text-decoration: none; font-weight: 600; margin-left: 15px; font-size: 0.9rem; transition: 0.3s; }
        .btn-nav:hover { color: #fff; }

        .search-container { margin-bottom: 25px; position: relative; }
        .search-input { width: 100%; padding: 15px 15px 15px 45px; background: #1a1c23; border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 1rem; outline: none; box-sizing: border-box; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #666; }

        .card { background: #1a1c23; padding: 25px 30px; border-radius: 12px; border: 1px solid #333; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; margin-bottom: 20px; color: #fff; text-transform: uppercase; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

        .badge-new { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .form-row { display: flex; gap: 20px; flex-wrap: wrap; } 
        .form-group { flex: 1; margin-bottom: 15px; min-width: 250px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; background: #0a0b0e; border: 1px solid #444; color: #fff; border-radius: 6px; outline: none; font-family: 'Montserrat'; transition: 0.3s; box-sizing: border-box; }
        input:focus, select:focus { border-color: #28a745; }

        .event-list-box { background: #0a0b0e; border: 1px solid #444; border-radius: 6px; max-height: 200px; overflow-y: auto; padding: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; }
        .checkbox-item:hover { background: #222; }
        .checkbox-item input { width: 18px; height: 18px; accent-color: #28a745; cursor: pointer; }
        .checkbox-label { font-size: 0.9rem; color: #ddd; cursor: pointer; flex: 1; }

        .btn-grant { background: #28a745; color: #fff; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .btn-grant:hover { background: #218838; transform: translateY(-2px); }

        .access-list { margin-top: 10px; display: flex; flex-direction: column; gap: 10px; }
        .access-item { display: flex; justify-content: space-between; align-items: center; background: #252830; padding: 15px; border-radius: 8px; border-left: 4px solid #444; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 10px; }
        .item-new { border-left-color: #e74c3c; background: #2c2020; }
        .item-active { border-left-color: #28a745; }

        .client-info { flex: 1; }
        .client-email { font-weight: 700; font-size: 0.95rem; color: #fff; display: block; margin-bottom: 3px; }
        .event-tag { background: rgba(40, 167, 69, 0.2); color: #2ecc71; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid rgba(40, 167, 69, 0.3); display: flex; align-items: center; gap: 5px; margin-right: 5px; margin-bottom: 5px; }
        .event-tags-container { display: flex; flex-wrap: wrap; margin-top: 5px; }

        .btn-revoke { background: transparent; color: #d9534f; border: 1px solid #d9534f; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: 0.3s; font-size: 0.8rem; font-weight: 600; }
        .btn-revoke:hover { background: #d9534f; color: white; }

        /* BUTTONS GROUP */
        .action-group { display: flex; gap: 8px; }
        .btn-quick-assign { background: #3498db; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .btn-delete-user { background: #e74c3c; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .btn-delete-user:hover { background: #c0392b; }

        .pass-item { display: flex; flex-direction: column; gap: 10px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; margin-bottom: 10px; }
        .pass-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .pass-input-group { display: flex; align-items: center; background: #000; border: 1px solid #333; border-radius: 4px; padding: 5px 10px; width: 250px; }
        .pass-input { background: transparent; border: none; color: #fff; width: 100%; letter-spacing: 2px; outline: none; padding: 5px; font-family: monospace; }
        .btn-eye { background: none; border: none; color: #666; cursor: pointer; padding: 5px; }
        .btn-update { background: #3498db; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; cursor: pointer; }

        .empty-state { text-align: center; color: #555; padding: 20px; font-style: italic; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; gap: 10px; }
            .access-item { flex-direction: column; align-items: flex-start; }
            .action-group { width: 100%; justify-content: flex-end; margin-top: 10px; }
            .pass-row { flex-direction: column; align-items: flex-start; gap: 10px; }
            .pass-input-group { width: 100%; }
            .btn-update { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="admin-dashboard.html" class="logo">SEA MOUNTAIN ADMIN</a>
        <div><a href="admin-dashboard.html" class="btn-nav">Dashboard</a></div>
    </div>

    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search client email...">
    </div>

    <div class="card">
        <h3 style="color: #28a745;"><i class="fas fa-user-lock"></i> Client Access Control</h3>
        <p style="color:#888; font-size:0.85rem; margin-bottom:20px; line-height:1.5;">
            Assign one or multiple events to a client.
        </p>
        <div class="form-row">
            <div class="form-group"> <label>Client Email</label>
                <input type="email" id="clientEmail" placeholder="client@example.com">
            </div>
            <div class="form-group"> <label>Select Target Events</label>
                <div id="eventCheckboxes" class="event-list-box">
                    <div style="color:#666; font-size:0.8rem; padding:5px;">Loading events...</div>
                </div>
            </div>
        </div>
        <button onclick="grantAccess()" class="btn-grant">GRANT PERMISSION</button>
    </div>

    <div class="card" style="border-color: #e74c3c;">
        <h3 style="color: #e74c3c;">
            <i class="fas fa-user-plus"></i> New Signups / Unassigned
            <span id="newCount" class="badge-new" style="display:none;">0</span>
        </h3>
        <div id="newAccountsList" class="access-list">
            <div class="empty-state">No new signups.</div>
        </div>
    </div>

    <div class="card">
        <h3 style="color: #fff;"><i class="fas fa-list"></i> Active Permissions</h3>
        <div id="permissionList" class="access-list">
            <div class="empty-state">Loading permissions...</div>
        </div>
    </div>

    <div class="card" style="border-color: #3498db;">
        <h3 style="color: #3498db;"><i class="fas fa-key"></i> Client Account Manager</h3>
        <div id="accountList">
            <div class="empty-state">Loading accounts...</div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
        authDomain: "sea-mountain.firebaseapp.com",
        databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sea-mountain",
        storageBucket: "sea-mountain.firebasestorage.app",
        messagingSenderId: "812228825024",
        appId: "1:812228825024:web:717049c1a64b39c8a60225"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let allEvents = {};
    let allPermissionsData = null; 

    // 1. LOAD EVENTS
    onValue(ref(db, 'events'), (snapshot) => {
        allEvents = snapshot.val() || {};
        const container = document.getElementById('eventCheckboxes');
        if(!allEvents) { container.innerHTML = '<div style="padding:10px;">No events found.</div>'; return; }
        container.innerHTML = ""; 
        Object.keys(allEvents).forEach(key => {
            container.innerHTML += `<label class="checkbox-item"><input type="checkbox" value="${key}" class="event-chk"><span class="checkbox-label">${allEvents[key].title}</span></label>`;
        });
        if(allPermissionsData) renderLists(allPermissionsData); 
    });

    function sanitizeEmail(email) { return email.replace(/\./g, ','); }

    window.grantAccess = function() {
        const email = document.getElementById('clientEmail').value.trim().toLowerCase();
        const checkboxes = document.querySelectorAll('.event-chk:checked');
        const selectedEvents = Array.from(checkboxes).map(cb => cb.value);

        if(!email) return alert("Please enter an email.");
        if(selectedEvents.length === 0) return alert("Please select at least one event.");

        const safeEmail = sanitizeEmail(email);
        const promises = selectedEvents.map(eventId => set(ref(db, `permissions/${safeEmail}/${eventId}`), true));

        Promise.all(promises).then(() => {
            alert(`Access granted for ${selectedEvents.length} events!`);
            document.getElementById('clientEmail').value = '';
            checkboxes.forEach(cb => cb.checked = false);
        }).catch(err => alert("Error: " + err.message));
    }

    // 4. LOAD & RENDER (With Search Logic)
    onValue(ref(db, 'permissions'), (snapshot) => {
        allPermissionsData = snapshot.val();
        renderLists(allPermissionsData); 
    });

    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        renderLists(allPermissionsData, e.target.value.toLowerCase());
    });

    function renderLists(data, searchTerm = "") {
        const newList = document.getElementById('newAccountsList');
        const activeList = document.getElementById('permissionList');
        const accList = document.getElementById('accountList');
        const newBadge = document.getElementById('newCount');
        
        newList.innerHTML = ""; activeList.innerHTML = ""; accList.innerHTML = "";
        let newCount = 0;

        if(data) {
            const emailKeys = Object.keys(data).sort();

            emailKeys.forEach(emailKey => {
                const originalEmail = emailKey.replace(/,/g, '.');
                
                if (!originalEmail.toLowerCase().includes(searchTerm)) return;

                const userObj = data[emailKey];
                const password = userObj.password || "";
                const passValue = userObj.password || "";
                const placeholder = userObj.password ? "" : "No password set";

                const assignedEvents = Object.keys(userObj).filter(k => k !== 'password' && k !== 'createdAt');
                const isAssigned = assignedEvents.length > 0;

                // 1. NEW ACCOUNTS
                if (!isAssigned) {
                    newCount++;
                    newList.innerHTML += `
                        <div class="access-item item-new">
                            <div class="client-info">
                                <span class="client-email" style="color:#e74c3c;">${originalEmail}</span>
                                <span style="font-size:0.75rem; color:#888;">Joined: ${userObj.createdAt ? new Date(userObj.createdAt).toLocaleDateString() : 'N/A'}</span>
                            </div>
                            <div class="action-group">
                                <button class="btn-quick-assign" onclick="fillEmail('${originalEmail}')">
                                    <i class="fas fa-arrow-up"></i> Select
                                </button>
                                <button class="btn-delete-user" onclick="deleteUser('${emailKey}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // 2. ACTIVE ACCOUNTS
                    let eventBadges = assignedEvents.map(eid => {
                        const eventName = allEvents[eid] ? allEvents[eid].title : eid;
                        return `
                            <div class="event-tag">
                                ${eventName} 
                                <i class="fas fa-times" onclick="revokeAccess('${emailKey}', '${eid}')" title="Revoke Access"></i>
                            </div>`;
                    }).join("");

                    activeList.innerHTML += `
                        <div class="access-item item-active">
                            <div class="client-info">
                                <span class="client-email">${originalEmail}</span>
                                <div class="event-tags-container">${eventBadges}</div>
                            </div>
                            <div class="action-group">
                                <button class="btn-quick-assign" onclick="fillEmail('${originalEmail}')" style="background:#444;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                                <button class="btn-delete-user" onclick="deleteUser('${emailKey}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }

                // 3. PASS MANAGER
                accList.innerHTML += `
                    <div class="pass-item">
                        <div class="pass-row">
                            <span style="font-weight:bold; color:#fff;">${originalEmail}</span>
                        </div>
                        <div class="pass-row">
                            <div class="pass-input-group">
                                <input type="password" class="pass-input" value="${passValue}" placeholder="${placeholder}" id="pass-${emailKey}">
                                <button class="btn-eye" onclick="togglePass('pass-${emailKey}')"><i class="fas fa-eye"></i></button>
                            </div>
                            <button class="btn-update" onclick="updateClientPass('${emailKey}')">
                                <i class="fas fa-save"></i> Update
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        if (newCount > 0) { newBadge.innerText = newCount; newBadge.style.display = "inline-block"; } 
        else { newBadge.style.display = "none"; if(!newList.innerHTML) newList.innerHTML = "<div class='empty-state'>No matching new signups.</div>"; }

        if (activeList.innerHTML === "") activeList.innerHTML = "<div class='empty-state'>No matching active clients.</div>";
        if (accList.innerHTML === "") accList.innerHTML = "<div class='empty-state'>No matching accounts.</div>";
    }

    window.fillEmail = function(email) {
        document.getElementById('clientEmail').value = email;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.revokeAccess = function(emailKey, eventId) {
        if(confirm("Revoke access to this event?")) {
            remove(ref(db, `permissions/${emailKey}/${eventId}`));
        }
    }

    // FUNGSI BARU: DELETE USER SEPENUHNYA
    window.deleteUser = function(emailKey) {
        if(confirm("WARNING: Delete this user permanently? \nThey will lose ALL access and login ability.")) {
            remove(ref(db, `permissions/${emailKey}`))
            .then(() => alert("User deleted successfully."))
            .catch(err => alert("Error: " + err.message));
        }
    }

    window.togglePass = function(id) {
        const x = document.getElementById(id);
        const icon = x.nextElementSibling.querySelector('i');
        if (x.type === "password") { x.type = "text"; icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash"); } 
        else { x.type = "password"; icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye"); }
    }

    window.updateClientPass = function(emailKey) {
        const newPass = document.getElementById(`pass-${emailKey}`).value;
        if (!newPass || newPass.length < 6) return alert("Invalid Password");
        if(confirm(`Set new password?`)) {
            update(ref(db, `permissions/${emailKey}`), { password: newPass })
            .then(() => alert("Password Updated!"))
            .catch((e) => alert(e.message));
        }
    }
</script>
</body>
</html>
