<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Smart Timing</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #0f1014; --card: #1a1c23; --accent: #00d2ff; --text: #fff; 
            --success: #2ecc71; --error: #e74c3c; --pending: #f39c12; 
            --sidebar-w: 260px;
        }
        * { box-sizing: border-box; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; min-height: 100vh; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-w); background: #000; border-right: 1px solid #333;
            display: flex; flex-direction: column; height: 100vh; position: fixed; left: 0; top: 0; z-index: 100;
            padding: 20px;
        }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -1px; margin-bottom: 20px; text-align: center; }
        .logo span { color: var(--accent); }

        .user-panel { 
            display: flex; flex-direction: column; gap: 10px; align-items: center; 
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333;
        }
        .timing-badge { 
            display: flex; align-items: center; gap: 8px; background: #111; 
            padding: 8px 12px; border-radius: 6px; border: 1px solid #333; 
            font-size: 0.8rem; color: #ccc; width: 100%; justify-content: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .btn-logout { 
            background: transparent; border: 1px solid #e74c3c; color: #e74c3c; 
            padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; 
            cursor: pointer; width: 100%; transition: 0.2s;
        }
        .btn-logout:hover { background: #e74c3c; color: #fff; }
        
        .clock-box {
            background: #111; border: 1px solid #333; padding: 15px; border-radius: 8px;
            text-align: center; margin-bottom: 30px;
        }
        .clock-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .live-clock { font-family: monospace; color: var(--accent); font-size: 1.5rem; font-weight: bold; }

        .nav-group { display: flex; flex-direction: column; gap: 10px; }
        .btn-side {
            background: transparent; border: 1px solid transparent; color: #aaa; padding: 12px 15px;
            border-radius: 8px; text-decoration: none; display: flex; align-items: center; gap: 10px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn-side:hover { background: #1a1c23; color: #fff; border-color: #333; }
        .btn-side.active { background: var(--accent); color: #000; }
        .btn-side i { width: 20px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-wrapper { 
            margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); 
            padding: 20px; min-height: 100vh; overflow-x: hidden;
        }

        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- HOME SCREEN --- */
        .home-wrapper { max-width: 1200px; margin: 0 auto; text-align: center; }
        
        .setup-area { background: var(--card); padding: 40px; border-radius: 15px; border: 1px solid #333; margin-bottom: 30px; }
        .event-select { width: 100%; max-width: 600px; padding: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 1rem; margin-bottom: 30px; outline: none; }
        .event-select:focus { border-color: var(--accent); }
        
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }
        .role-card { background: #000; padding: 30px 20px; border-radius: 12px; cursor: pointer; border: 2px solid #333; transition: 0.3s; }
        .role-card:hover { transform: translateY(-5px); border-color: #555; }
        .role-card i { font-size: 2.5rem; margin-bottom: 15px; display: block; color: #555; }
        .role-repc:hover { border-color: #f39c12; } .role-repc:hover i { color: #f39c12; }
        .role-race:hover { border-color: var(--accent); } .role-race:hover i { color: var(--accent); }

        /* --- LEADERBOARD --- */
        .leaderboard-section { background: var(--card); border-radius: 15px; border: 1px solid #333; overflow: hidden; margin-top: 30px; }
        .leaderboard-header { padding: 15px; background: #111; border-bottom: 1px solid #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .lb-title { color: var(--accent); text-transform: uppercase; font-size: 1.1rem; letter-spacing: 1px; }
        
        .data-table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { text-align: left; padding: 12px 15px; background: #151515; color: #aaa; font-size: 0.75rem; text-transform: uppercase; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #333; }
        td { padding: 12px 15px; border-bottom: 1px solid #2a2c35; font-size: 0.85rem; vertical-align: middle; }
        tr:hover { background: #222; }
        
        .pos-badge { display: inline-block; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 50%; font-weight: bold; background: #333; color: #fff; font-size: 0.8rem; }
        .pos-1 { background: #f1c40f; color: #000; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .pos-2 { background: #bdc3c7; color: #000; }
        .pos-3 { background: #cd7f32; color: #000; }

        .time-cell { font-family: monospace; color: #ccc; }
        .finish-cell { font-family: monospace; font-weight: bold; color: var(--success); font-size: 1rem; }
        .country-flag { vertical-align: middle; margin-right: 5px; width: 20px; }

        /* --- SCANNER --- */
        .scanner-layout { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; align-items: start; }
        .left-panel { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #333; position: sticky; top: 20px; }
        .top-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-badge { flex:1; background:#000; border:1px solid #333; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:var(--accent); letter-spacing: 1px; padding: 10px; }

        .scan-status { background: #000; padding: 30px; border-radius: 12px; text-align: center; border: 2px solid #333; margin-bottom: 20px; transition: 0.2s; }
        .scan-status.success { border-color: var(--success); background: rgba(46, 204, 113, 0.05); }
        .scan-status.error { border-color: var(--error); background: rgba(231, 76, 60, 0.05); }
        .scan-msg { color: #888; font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; }
        .scan-name { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; line-height: 1.2; }
        .scan-bib { font-family: monospace; color: var(--accent); font-size: 1.4rem; cursor: pointer; text-decoration: underline; background: #222; padding: 5px 15px; border-radius: 5px; display: inline-block; }
        .scan-time { margin-top: 15px; color: #666; font-size: 0.9rem; }

        .manual-input { width: 100%; padding: 15px; background: #111; border: 1px solid #444; color: #fff; text-align: center; font-size: 1.1rem; border-radius: 8px; margin-bottom: 20px; outline: none; }
        .manual-input:focus { border-color: var(--accent); }

        .stats-row { display: flex; gap: 10px; }
        .stat-box { flex: 1; background: #111; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-num { font-size: 1.5rem; font-weight: 800; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }

        /* RIGHT PANEL */
        .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .table-card { background: var(--card); border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        .table-header { padding: 15px; background: #111; border-bottom: 1px solid #333; font-weight: bold; color: #888; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; font-size: 0.85rem; }
        
        .row-time { font-family: monospace; font-weight: bold; color: var(--success); }
        .row-pending { color: var(--pending); font-weight: bold; font-size: 0.8rem; }
        .row-id { font-family: monospace; color: #888; cursor: pointer; }
        .row-id:hover { color: #fff; text-decoration: underline; }

        .btn-toggle-mobile { display: none; }
        #rfidInput { position: fixed; top: -1000px; opacity: 0; }

        @media (max-width: 1000px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: sticky; top: 0; flex-direction: row; align-items: center; justify-content: space-between; padding: 10px 20px; }
            .logo { margin-bottom: 0; font-size: 1rem; }
            .user-panel { display: none; } 
            .clock-box { display: none; } 
            .nav-group { display: flex; flex-direction: row; }
            .btn-side span { display: none; } 
            
            .main-wrapper { margin-left: 0; width: 100%; padding: 10px; }
            .role-grid { grid-template-columns: 1fr; }
            .scanner-layout { grid-template-columns: 1fr; gap: 10px; }
            .left-panel { position: static; padding: 15px; }
            .scan-name { font-size: 1.5rem; }
            .btn-toggle-mobile { display: block; width: 100%; padding: 15px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
            .right-panel { display: none; } 
            .right-panel.show { display: block; }
            .leaderboard-section { display: none; }
        }
    </style>
</head>
<body>

    <input type="text" id="rfidInput" autofocus autocomplete="off">

    <nav class="sidebar">
        <div class="logo">SEA <span>TIMING</span></div>
        
        <div class="user-panel">
            <div class="timing-badge" id="timingDisplay">
                <i class="fas fa-spinner fa-spin"></i> Checking...
            </div>
            <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="clock-box">
            <div class="clock-label">Live System Time</div>
            <div class="live-clock" id="clock">00:00:00</div>
        </div>

        <div class="nav-group">
            <button onclick="goHome()" class="btn-side" title="Home"><i class="fas fa-home"></i> <span>Home / Reset</span></button>
            <a href="timing-rfid.html" class="btn-side" title="RFID Manager"><i class="fa-regular fa-id-card"></i> <span>RFID Manager</span></a>
            <a href="admin-login.html" class="btn-side" title="Back to Admin"><i class="fas fa-arrow-left"></i> <span>Admin Panel</span></a>
        </div>
    </nav>

    <div class="main-wrapper">

        <div id="screen-home" class="screen active">
            <div class="home-wrapper">
                
                <div class="setup-area">
                    <h2 style="margin-bottom:10px; text-transform:uppercase;">Select Event & Role</h2>
                    <p style="color:#888; margin-bottom:20px; font-size:0.9rem;">Choose the event and your station to start scanning.</p>
                    
                    <select id="globalEventSelect" class="event-select"><option value="">-- Loading Events --</option></select>
                    
                    <div class="role-grid">
                        <div class="role-card role-repc" onclick="selectRole('REPC')">
                            <i class="fas fa-box-open"></i><h3>REPC STAFF</h3><p style="color:#888; font-size:0.8rem;">Kit Collection</p>
                        </div>
                        <div class="role-card role-race" onclick="selectRole('RACE')">
                            <i class="fas fa-flag-checkered"></i><h3>RACE MARSHAL</h3><p style="color:#888; font-size:0.8rem;">Race Day Timing</p>
                        </div>
                    </div>
                </div>

                <div class="leaderboard-section" id="overallLeaderboard">
                    <div class="leaderboard-header">
                        <span class="lb-title"><i class="fas fa-trophy"></i> Live Race Overview</span>
                        <span style="font-size:0.8rem; color:#666;">Auto-updates</span>
                    </div>
                    <div class="data-table-container">
                        <table id="leaderboardTable">
                            <thead>
                                <tr>
                                    <th style="text-align:center;">Pos</th>
                                    <th>Event</th> <th>Bib / ID</th>
                                    <th>Name</th>
                                    <th>Country</th>
                                    <th>Category</th>
                                    <th>TA1</th>
                                    <th>TA2</th>
                                    <th>TA3</th>
                                    <th>Finish Time</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                <tr><td colspan="10" style="text-align:center; padding:30px; color:#666;">Select an event above to load data.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <div id="screen-cp-select" class="screen">
            <div class="home-wrapper">
                <button class="btn-side" onclick="goHome()" style="margin-bottom:20px; width:fit-content; background:#333;"><i class="fas fa-arrow-left"></i> Back</button>
                <h2 style="margin-bottom:30px;">SELECT CHECKPOINT</h2>
                <div class="role-grid">
                    <div class="role-card" onclick="startScanner('TA1')"><h3>TA1</h3></div>
                    <div class="role-card" onclick="startScanner('TA2')"><h3>TA2</h3></div>
                    <div class="role-card" onclick="startScanner('TA3')"><h3>TA3</h3></div>
                    <div class="role-card role-race" onclick="startScanner('FINISH')"><h3>FINISH LINE</h3></div>
                </div>
            </div>
        </div>

        <div id="screen-scanner" class="screen">
            <div class="scanner-layout">
                
                <div class="left-panel">
                    <div class="top-controls">
                        <div class="mode-badge" id="displayMode">LOADING...</div>
                    </div>
                    <div id="scanStatusCard" class="scan-status">
                        <div class="scan-msg" id="statusMsg">READY TO SCAN</div>
                        <div class="scan-name" id="statusName">...</div>
                        <div class="scan-bib" id="statusBib" onclick="copyText(this.innerText)" title="Click to Copy">---</div>
                        <div class="scan-time" id="statusTime">--:--:--</div>
                    </div>
                    <input type="text" id="manualInput" class="manual-input" placeholder="Type ID Manual & Enter">
                    <div class="stats-row">
                        <div class="stat-box"><div class="stat-num" id="countScanned">0</div><div class="stat-label">SCANNED</div></div>
                        <div class="stat-box"><div class="stat-num" id="countPending">0</div><div class="stat-label">PENDING</div></div>
                        <div class="stat-box"><div class="stat-num" id="countTotal">0</div><div class="stat-label">TOTAL</div></div>
                    </div>
                </div>

                <button class="btn-toggle-mobile" onclick="toggleTableMobile()"><i class="fas fa-list"></i> SHOW LISTS</button>

                <div class="right-panel" id="tablePanel">
                    <div class="table-card">
                        <div class="table-header">
                            <span style="color:var(--success);">LIVE FEED (SCANNED)</span>
                            <i class="fas fa-check-circle" style="color:var(--success);"></i>
                        </div>
                        <div class="data-table-container">
                            <table id="tableScanned">
                                <thead><tr><th>Time</th><th>ID (Copy)</th><th>Name</th><th>Status</th></tr></thead>
                                <tbody id="tbodyScanned"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="table-card">
                        <div class="table-header">
                            <span style="color:var(--pending);">PENDING LIST</span>
                            <i class="fas fa-hourglass-half" style="color:var(--pending);"></i>
                        </div>
                        <div class="data-table-container">
                            <table id="tablePending">
                                <thead><tr><th>Category</th><th>ID (Copy)</th><th>Name</th><th>Status</th></tr></thead>
                                <tbody id="tbodyPending"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBZzcjRx3KhBaHaahSUee1ySRIlRgVmi3o",
        authDomain: "sea-mountain.firebaseapp.com",
        databaseURL: "https://sea-mountain-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sea-mountain",
        storageBucket: "sea-mountain.firebasestorage.app",
        messagingSenderId: "812228825024",
        appId: "1:812228825024:web:717049c1a64b39c8a60225"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ALLOWED_TIMING_USERS = ["admin@sm.com", "crew@sm.com"];

    let currentEventId = "";
    let activeMode = "";
    let allParticipants = [];

    const beepSuccess = new Audio("https://www.soundjay.com/button/beep-07.wav");
    const beepError = new Audio("https://www.soundjay.com/button/button-10.mp3");

    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);

    window.copyText = function(text) {
        if(text === "---" || text === "...") return;
        navigator.clipboard.writeText(text).then(() => alert("ID Copied: " + text));
    }

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        if (user && ALLOWED_TIMING_USERS.includes(user.email)) {
            const icon = user.email.includes("admin") ? "user-shield" : "user-clock";
            document.getElementById('timingDisplay').innerHTML = `<i class="fas fa-${icon}"></i> ${user.email}`;
        } else {
            alert("ACCESS DENIED: Unauthorized Account");
            window.location.href = "timing-login.html"; 
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm("Log out form Timing System?")) {
            signOut(auth).then(() => { window.location.href = "timing-login.html"; });
        }
    });

    // --- NAVIGATION ---
    window.selectRole = function(role) {
        currentEventId = document.getElementById('globalEventSelect').value;
        if(!currentEventId) { alert("Please select an event first!"); return; }
        if(role === 'REPC') startScanner('REPC');
        else showScreen('screen-cp-select');
    }

    window.startScanner = function(mode) {
        activeMode = mode;
        document.getElementById('displayMode').innerText = (mode === 'REPC') ? "REPC COUNTER" : mode + " CHECKPOINT";
        showScreen('screen-scanner');
        renderScannerUI(); 
    }

    window.goHome = function() {
        if(activeMode && !confirm("Exit session?")) return;
        activeMode = ""; 
        showScreen('screen-home'); 
        renderLeaderboard();
    }

    window.toggleTableMobile = function() {
        document.getElementById('tablePanel').classList.toggle('show');
    }

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    // --- LOAD EVENTS & DATA ---
    const eventSelect = document.getElementById('globalEventSelect');
    
    onValue(ref(db, 'events'), (snap) => {
        eventSelect.innerHTML = '<option value="">-- Select Event First --</option>';
        
        // TAMBAH OPTION "ALL EVENTS"
        eventSelect.innerHTML += '<option value="all" style="font-weight:bold; color:#00d2ff;">ALL EVENTS (VIEW & MANAGE)</option>';

        const data = snap.val();
        if(data) Object.keys(data).forEach(k => eventSelect.innerHTML += `<option value="${k}">${data[k].title}</option>`);
    });

    eventSelect.addEventListener('change', (e) => {
        currentEventId = e.target.value;
        if(currentEventId) {
            loadData(currentEventId);
        } else {
            document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="10" style="text-align:center;">Select an event to load data.</td></tr>';
        }
    });

    function loadData(eventId) {
        document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="10" style="text-align:center;">Loading data...</td></tr>';
        
        // JIKA PILIH "ALL EVENTS"
        let dbRef;
        if(eventId === 'all') {
            dbRef = ref(db, 'registrations');
        } else {
            dbRef = ref(db, `registrations/${eventId}`);
        }

        onValue(dbRef, (snap) => {
            const data = snap.val();
            allParticipants = [];
            
            if(data) {
                // LOGIK UNTUK "ALL"
                if(eventId === 'all') {
                    Object.keys(data).forEach(evId => {
                        const eventData = data[evId];
                        Object.keys(eventData).forEach(userId => {
                            const p = eventData[userId];
                            // Tambah field 'eventId' supaya kita tahu dia dari mana
                            allParticipants.push({id: userId, eventId: evId, ...p});
                        });
                    });
                } 
                // LOGIK UNTUK SINGLE EVENT
                else {
                    Object.keys(data).forEach(k => {
                        allParticipants.push({id: k, eventId: eventId, ...data[k]});
                    });
                }
            }
            
            if(!activeMode) renderLeaderboard();
            else renderScannerUI();
        });
    }

    // --- RENDER FUNCTIONS ---
    function renderLeaderboard() {
        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = "";

        if(allParticipants.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">No participants found.</td></tr>';
            return;
        }

        const sorted = [...allParticipants].sort((a, b) => {
            if (a.finish_time && b.finish_time) return a.finish_time.localeCompare(b.finish_time);
            if (a.finish_time) return -1;
            if (b.finish_time) return 1;
            return 0;
        });

        let rank = 1;
        sorted.forEach(p => {
            let posHtml = `<span class="pos-badge" style="background:#444;">-</span>`;
            if(p.finish_time) {
                let colorClass = "";
                if(rank === 1) colorClass = "pos-1";
                else if(rank === 2) colorClass = "pos-2";
                else if(rank === 3) colorClass = "pos-3";
                else colorClass = "style='background:#444'";
                
                posHtml = `<span class="pos-badge ${colorClass}">${rank++}</span>`;
            }

            const flagUrl = "https://flagcdn.com/24x18/my.png"; 
            const countryCode = "MYS";
            // Guna BIB atau ID Pendek
            const displayBib = p.bib || p.id.substring(0,6) + "..";

            const row = `
                <tr>
                    <td style="text-align:center;">${posHtml}</td>
                    <td style="color:var(--accent); text-transform:uppercase; font-size:0.8rem; font-weight:bold;">${p.eventId || currentEventId}</td>
                    <td class="row-id" onclick="copyText('${p.id}')">${displayBib}</td>
                    <td>${p.first_name}</td>
                    <td><img src="${flagUrl}" class="country-flag"> ${countryCode}</td>
                    <td>${p.category}</td>
                    <td class="time-cell">${p.time_TA1 || '-'}</td>
                    <td class="time-cell">${p.time_TA2 || '-'}</td>
                    <td class="time-cell">${p.time_TA3 || '-'}</td>
                    <td class="finish-cell">${p.finish_time || '-'}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function renderScannerUI() {
        const total = allParticipants.length;
        let scannedCount = 0;
        
        const tbodyScanned = document.getElementById('tbodyScanned');
        const tbodyPending = document.getElementById('tbodyPending');
        tbodyScanned.innerHTML = "";
        tbodyPending.innerHTML = "";

        const scannedList = [];
        const pendingList = [];

        allParticipants.forEach(p => {
            let isScanned = false;
            let timeDisplay = "-";

            if(activeMode === 'REPC' && p.kit_collected) { isScanned = true; timeDisplay = "Collected"; }
            else if(activeMode === 'TA1' && p.time_TA1) { isScanned = true; timeDisplay = p.time_TA1; }
            else if(activeMode === 'TA2' && p.time_TA2) { isScanned = true; timeDisplay = p.time_TA2; }
            else if(activeMode === 'TA3' && p.time_TA3) { isScanned = true; timeDisplay = p.time_TA3; }
            else if(activeMode === 'FINISH' && p.race_status === 'FINISHER') { isScanned = true; timeDisplay = p.finish_time; }

            p.displayTime = timeDisplay; 

            if(isScanned) scannedList.push(p);
            else pendingList.push(p);
        });

        scannedCount = scannedList.length;
        scannedList.reverse();

        scannedList.forEach(p => {
            const displayBib = p.bib || p.id.substring(0,6) + "..";
            tbodyScanned.innerHTML += `
                <tr>
                    <td class="row-time">${p.displayTime}</td>
                    <td class="row-id" onclick="copyText('${p.id}')">${displayBib}</td>
                    <td>${p.first_name}</td>
                    <td><i class="fas fa-check-circle" style="color:var(--success)"></i></td>
                </tr>`;
        });

        pendingList.forEach(p => {
            const displayBib = p.bib || p.id.substring(0,6) + "..";
            tbodyPending.innerHTML += `
                <tr>
                    <td>${p.category}</td>
                    <td class="row-id" onclick="copyText('${p.id}')">${displayBib}</td>
                    <td>${p.first_name}</td>
                    <td class="row-pending">PENDING</td>
                </tr>`;
        });

        document.getElementById('countTotal').innerText = total;
        document.getElementById('countScanned').innerText = scannedCount;
        document.getElementById('countPending').innerText = total - scannedCount;
    }

    // --- SCANNER LOGIC ---
    const rfidInput = document.getElementById('rfidInput');
    const manualInput = document.getElementById('manualInput');

    document.addEventListener('click', (e) => {
        if(e.target !== manualInput && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'A') {
            rfidInput.focus();
        }
    });

    rfidInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') { processScan(rfidInput.value.trim()); rfidInput.value = ""; }
    });

    manualInput.addEventListener('keyup', (e) => {
        if(e.key === 'Enter') { processScan(manualInput.value.trim()); manualInput.value = ""; rfidInput.focus(); }
    });

    function processScan(tagId) {
        if(!tagId || !activeMode) return;

        // JIKA MOD 'ALL', kita kena cari user tu dari list local dulu untuk dapatkan eventId dia
        let targetEventId = currentEventId;
        if(currentEventId === 'all') {
            const user = allParticipants.find(p => p.rfid_tag === tagId || p.id === tagId); // Cek RFID atau Key
            if(user) {
                targetEventId = user.eventId;
            } else {
                // Cuba cari direct dari database global (kalau local tak jumpa)
                // Ini susah sikit sebab kena query semua.
                // Untuk simple, kita assume tagId tu USER KEY (-OhB...)
                // Tapi kalau tagId tu RFID tag, kita tak boleh direct.
                // Jadi untuk mode ALL, better scan RFID tag yang dah di-map.
                
                // Fallback: Show Not Found
                showFeedback(false, "TAG NOT FOUND IN LOADED LIST", { first_name: "UNKNOWN", last_name: "", id: tagId });
                return;
            }
        }

        const userRef = ref(db, `registrations/${targetEventId}/${tagId}`);
        
        onValue(userRef, (snap) => {
            if(snap.exists()) {
                const data = snap.val();
                const updates = {};
                const now = new Date().toLocaleTimeString();
                let success = false;

                if(activeMode === 'REPC') {
                    if(data.kit_collected) { showFeedback(false, "ALREADY COLLECTED", data); return; }
                    updates['kit_collected'] = true; success = true;
                } else if(activeMode === 'FINISH') {
                    if(data.race_status === 'FINISHER') { showFeedback(false, "ALREADY FINISHED", data); return; }
                    updates['race_status'] = 'FINISHER'; updates['finish_time'] = now; success = true;
                } else {
                    const keyName = `time_${activeMode}`;
                    if(data[keyName]) { showFeedback(false, "ALREADY SCANNED", data); return; }
                    updates[keyName] = now; success = true;
                }

                if(success) {
                    update(userRef, updates).then(() => showFeedback(true, "SUCCESS: " + activeMode, data));
                }
            } else {
                // Kalau guna RFID Tag (bukan key), kena cari dalam list
                const userByTag = allParticipants.find(p => p.rfid_tag === tagId);
                if(userByTag) {
                    // Jumpa guna RFID! Panggil semula processScan guna ID sebenar
                    processScan(userByTag.id);
                } else {
                    showFeedback(false, "TAG NOT FOUND", { first_name: "UNKNOWN", last_name: "", id: tagId });
                }
            }
        }, {onlyOnce: true});
    }

    function showFeedback(isSuccess, msg, pData) {
        const card = document.getElementById('scanStatusCard');
        document.getElementById('statusMsg').innerText = msg;
        document.getElementById('statusName').innerText = pData.first_name + " " + (pData.last_name || "");
        document.getElementById('statusBib').innerText = pData.bib || pData.id || "---"; // Papar BIB
        document.getElementById('statusTime').innerText = new Date().toLocaleTimeString();

        card.className = "scan-status"; 
        if(isSuccess) { card.classList.add('success'); beepSuccess.play(); } 
        else { card.classList.add('error'); beepError.play(); }
    }
</script>
</body>
</html>
